(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.BulletManager=exports.Bullet=undefined;var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _entity=require("./entity");var _utils=require("./utils");var _global=require("./global");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Bullet=exports.Bullet=function(_Entity){_inherits(Bullet,_Entity);function Bullet(owner,type,callback){_classCallCheck(this,Bullet);var dx=(0,_utils.cos)(owner.angle);var dy=(0,_utils.sin)(owner.angle);var vel=(0,_global.bulletVelocity)(type);var size=vel>5&&type&_global.BULLET.FIRE?2:1;var _this=_possibleConstructorReturn(this,(Bullet.__proto__||Object.getPrototypeOf(Bullet)).call(this,owner.cx+dx,owner.cy+dy,size,owner.angle,vel));_this.owner=owner;_this.type=type;_this.callback=callback;_this.particleCallback=function(){};return _this}_createClass(Bullet,[{key:"setParticleCallback",value:function setParticleCallback(callback){this.particleCallback=callback}},{key:"died",value:function died(){if(this.alive){this.particleCallback(this);this.alive=false;this.callback()}}},{key:"draw",value:function draw(level){var texture=this.type&_global.BULLET.FIRE?level.textures.fireSmall[this.angle]:level.textures.bullet;if(this.size>1.5)texture=level.textures.fireLong[this.angle];level.drawEntity(this,texture)}},{key:"update",value:function update(level,time){if(!this.alive)return;this.move(this.getDelta(time));if(level.collideBullet(this,(this.type&_global.BULLET.POWER)===_global.BULLET.POWER))this.died()}}]);return Bullet}(_entity.Entity);var BulletManager=exports.BulletManager=function(_EntityManager){_inherits(BulletManager,_EntityManager);function BulletManager(event,mode){_classCallCheck(this,BulletManager);var _this2=_possibleConstructorReturn(this,(BulletManager.__proto__||Object.getPrototypeOf(BulletManager)).call(this));_this2.mode=mode;_this2.particleCallback=function(bullet){event.emit("particle",bullet.cx,bullet.cy,bullet.type&_global.BULLET.FIRE?_global.PART.FIRE:_global.PART.SPARK)};return _this2}_createClass(BulletManager,[{key:"add",value:function add(bullet){bullet.setParticleCallback(this.particleCallback);this.objects.push(bullet)}},{key:"collideTank",value:function collideTank(tank){var _this3=this;if(tank.state<=_global.STATE.RESPAWN)return;this.objects.forEach(function(bullet){if(!bullet.alive||bullet.owner===tank)return;if(tank.collide(bullet,(0,_global.tankRadius)(tank.type),.5)){bullet.died();var table=[0,0,1,1,1,1,1,1,2];if(table[bullet.owner.type]!==table[tank.type]||bullet.owner.zombie||_this3.mode==="bench"){tank.damage((0,_global.bulletDamage)(bullet.type),bullet.owner.type<=_global.TANK.TANK2)}}})}},{key:"update",value:function update(level,time){var _this4=this;var collide=function collide(bullet){if(!bullet.alive)return;for(var i=0;i<_this4.objects.length;i++){if(_this4.objects[i].alive&&bullet.collide(_this4.objects[i],.5,.5)){var myFire=!!(bullet.type&_global.BULLET.FIRE);var otherFire=!!(_this4.objects[i].type&_global.BULLET.FIRE);if(!myFire||otherFire)bullet.died();else bullet.particleCallback(bullet);if(!otherFire||myFire)_this4.objects[i].died();else _this4.objects[i].particleCallback(_this4.objects[i]);return}}};this.objects.forEach(collide);_get(BulletManager.prototype.__proto__||Object.getPrototypeOf(BulletManager.prototype),"update",this).call(this,level,time)}}]);return BulletManager}(_entity.EntityManager)},{"./entity":2,"./global":7,"./utils":15}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.EntityManager=exports.Entity=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _utils=require("./utils");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Entity=exports.Entity=function(){function Entity(cx,cy){var size=arguments.length>2&&arguments[2]!==undefined?arguments[2]:2;var angle=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var vel=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;_classCallCheck(this,Entity);this.cx=cx;this.cy=cy;this.size=size;this.angle=angle;this.vel=vel;this.lastTime=0;this.alive=true}_createClass(Entity,[{key:"getDelta",value:function getDelta(time){if(!this.lastTime)this.lastTime=time;var delta=time-this.lastTime;this.lastTime=time;return delta}},{key:"moveImpl",value:function moveImpl(delta,sinFun,cosFun){var koef=80/1024/25;var dx=cosFun(this.angle)*this.vel*delta*koef;var dy=sinFun(this.angle)*this.vel*delta*koef;this.cx+=dx;this.cy+=dy}},{key:"move",value:function move(delta){this.moveImpl(delta,_utils.sin,_utils.cos)}},{key:"moveEx",value:function moveEx(delta){this.moveImpl(delta,Math.sin,Math.cos)}},{key:"collide",value:function collide(other,mySizeKoef,otherSizeKoef){if(this===other)return false;var minRadius=this.size*mySizeKoef*.5+other.size*otherSizeKoef*.5;return Math.abs(this.cx-other.cx)<=minRadius&&Math.abs(this.cy-other.cy)<=minRadius}},{key:"clear",value:function clear(level){level.clearEntity(this)}}]);return Entity}();var EntityManager=exports.EntityManager=function(){function EntityManager(){_classCallCheck(this,EntityManager);this.objects=[]}_createClass(EntityManager,[{key:"reset",value:function reset(){this.objects=[]}},{key:"clear",value:function clear(level){this.objects.forEach(function(obj){return obj.clear(level)})}},{key:"draw",value:function draw(level){this.objects.forEach(function(obj){return obj.draw(level)})}},{key:"update",value:function update(level,time){this.objects.forEach(function(obj){return obj.update(level,time)});this.splice()}},{key:"splice",value:function splice(){for(var index=0;index<this.objects.length;){if(this.objects[index].alive){index++}else{this.objects.splice(index,1)}}}}]);return EntityManager}()},{"./utils":15}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Event=function(){function Event(){_classCallCheck(this,Event);this.events=[]}_createClass(Event,[{key:"on",value:function on(eventName,callback){if(!(eventName in this.events)){this.events[eventName]=[]}this.events[eventName].push({callback:callback});console.assert(this.events[eventName].length<10,"too many listeners")}},{key:"emit",value:function emit(eventName){for(var _len=arguments.length,param=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){param[_key-1]=arguments[_key]}var event=this.events[eventName];if(event&&event.length>0){event.forEach(function(listeners){return listeners.callback.apply(listeners,param)})}}}]);return Event}();exports.default=Event},{}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _ref;var _utils=require("./utils");var _level=require("./level");var _entity=require("./entity");var _tank=require("./tank");var _tank2=_interopRequireDefault(_tank);var _bullet=require("./bullet");var _particle=require("./particle");var _particle2=_interopRequireDefault(_particle);var _global=require("./global");var _event=require("./event");var _event2=_interopRequireDefault(_event);var _item=require("./item");var _item2=_interopRequireDefault(_item);var _replay=require("./replay");var _replay2=_interopRequireDefault(_replay);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}var keyToAngle=[{38:0,39:1,40:2,37:3},(_ref={},_defineProperty(_ref,"W".charCodeAt(0),0),_defineProperty(_ref,"D".charCodeAt(0),1),_defineProperty(_ref,"S".charCodeAt(0),2),_defineProperty(_ref,"A".charCodeAt(0),3),_ref)];var maskToAngle={1:0,2:1,4:2,8:3};var keyShoot=[" ".charCodeAt(0),"Q".charCodeAt(0)];var angleToKey={0:38,1:39,2:40,3:37};var Menu=function Menu(text,width,height,copyReplay,nextLevel){var replayCopied=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;_classCallCheck(this,Menu);var _getMapSize=(0,_utils.getMapSize)(),mapWidth=_getMapSize.mapWidth,mapHeight=_getMapSize.mapHeight;var size=(0,_utils.getTileSize)(width,height);this.entity=new _entity.Entity((mapWidth-1)/2,(mapHeight-1)/2,14);this.layer=new _level.Layer(this.entity.size*size,this.entity.size*size);var ctx=this.layer.context;ctx.globalAlpha=.75;ctx.fillStyle="rgb(193, 156, 34)";ctx.fillRect(0,4*size,this.layer.canvas.width,this.layer.canvas.height-8*size);ctx.globalAlpha=1;ctx.fillStyle="rgb(198, 205, 242)";ctx.textAlign="center";ctx.font=(size*1.5|0)+"px Verdana, Geneva, Arial, Helvetica, sans-serif";var h=copyReplay||replayCopied||nextLevel?-size/2:size/2;ctx.fillText(text,this.layer.canvas.width/2,this.layer.canvas.height/2+h);this.replayCopiedMenu=null;if(copyReplay||replayCopied){ctx.font=(size*.5|0)+"px Verdana, Geneva, Arial, Helvetica, sans-serif";if(copyReplay){ctx.fillStyle="rgb(60, 90, 255)";ctx.fillText("Press 'R' to copy replay to the clipboard",this.layer.canvas.width/2,this.layer.canvas.height/2+size);this.replayCopiedMenu=new Menu(text,width,height,false,nextLevel,true)}else{ctx.fillStyle="rgb(60, 200, 90)";ctx.fillText("Replay has been copied to the clipboard",this.layer.canvas.width/2,this.layer.canvas.height/2+size)}}if(nextLevel){ctx.fillStyle="rgb(60, 90, 255)";ctx.font=(size*.5|0)+"px Verdana, Geneva, Arial, Helvetica, sans-serif";ctx.fillText("Press 'SPACE' to go to the next level",this.layer.canvas.width/2,this.layer.canvas.height/2+size*2)}};var Game=function(){function Game(canvas,params){var _this=this;_classCallCheck(this,Game);var isPlayback=params.mode==="replay";if(isPlayback){this.playback=new _replay2.default;this.playback.load(params.base64)}var currentDifficulty=isPlayback?this.playback.difficulty:parseInt(params.difficulty,10);this.currentLevel=isPlayback?this.playback.level:0;this.canvas=canvas;this.mode=params.mode;var _getMapSize2=(0,_utils.getMapSize)(),mapWidth=_getMapSize2.mapWidth,mapHeight=_getMapSize2.mapHeight;this.mapWidth=mapWidth-2;this.mapHeight=mapHeight-2;this.event=new _event2.default;this.particles=new _particle2.default(this.event);this.tanks=new _tank2.default(currentDifficulty,this.event,this.mode);this.bullets=new _bullet.BulletManager(this.event,this.mode);this.items=new _item2.default(currentDifficulty,this.event,this.mode);this.pauseMenu=new Menu("Pause",canvas.width,canvas.height,!isPlayback,false);this.loadMenu=new Menu("Loading",canvas.width,canvas.height,false,false);this.completeMenu=new Menu("Level Complete",canvas.width,canvas.height,!isPlayback,!isPlayback);this.gameoverMenu=new Menu("Game Over",canvas.width,canvas.height,!isPlayback,false);this.menu=null;this.level=null;this.replay=null;this.drawLoading=false;this.gameover=false;this.levelComplete=false;var isTwoPlayers=isPlayback?this.playback.players.length>1:params.twoplayers==="true";var tank1=this.tanks.create(_global.TANK.TANK1);var tank2=isTwoPlayers?this.tanks.create(_global.TANK.TANK2):null;this.players=[tank1,tank2];if(isPlayback){this.tanks.life=this.playback.life;this.tanks.scores=this.playback.scores;this.tanks.total_scores=this.playback.total_scores;this.tanks.items=this.playback.items;for(var type in this.playback.players){this.players[type].life=this.playback.players[type].life;if(this.playback.players[type].maxVelocity)this.players[type].velocity=(0,_global.tankVelocity)(_global.TANK.BMP);this.players[type].weapon.setType(this.playback.players[type].weaponType)}this.playback.leftItems.forEach(function(item){_this.items.addItem(item.type,item.cx,item.cy)})}this.event.on("levelCreated",function(){if(_this.mode==="level"){_this.replay=new _replay2.default(_this.currentLevel,_this.items,_this.tanks)}else if(_this.mode==="replay"){_utils.Random.setSeed(_this.playback.random_seed)}_this.startLevelTime=Date.now();_this.updateTime=0;_this.particles.reset();_this.tanks.reset();_this.bullets.reset();_this.items.reset();_this.pauseTime=0;_this.startPauseTime=0;_this.drawLoading=false;_this.levelComplete=false;_this.menu=null;_this.keyMask=[0,0];_this.shootKeyPress=[false,false];_this.axes=[false,false,false,false]});this.event.on("playerCreated",function(tank){_this.players[tank.type]=tank});this.event.on("gameOver",function(){_this.pause();_this.gameover=true;_this.changeMenu(_this.gameoverMenu)});this.event.on("levelComplete",function(){if(_this.replay)_this.replay.save();_this.levelComplete=true;_this.changeMenu(_this.completeMenu)})}_createClass(Game,[{key:"newLevel",value:function newLevel(){var name=this.mode==="replay"?"level":this.mode;var levelName="levels/"+name;if(name==="level")levelName+=""+this.currentLevel;this.level=new _level.Level(levelName,this.canvas,this.event)}},{key:"update",value:function update(){if(!this.level){if(!this.drawLoading){var x=this.canvas.width/2-this.loadMenu.layer.canvas.width/2;var y=this.canvas.height/2-this.loadMenu.layer.canvas.height/2;this.canvas.getContext("2d").drawImage(this.loadMenu.layer.canvas,x,y);this.drawLoading=true}else{this.newLevel()}}if(!this.level||!this.level.ready())return;var timeOffset=this.startPauseTime?Date.now()-this.startPauseTime:0;var currentTime=Date.now()-this.pauseTime-timeOffset-this.startLevelTime;if(currentTime>_global.LEVEL_TIME)this.event.emit("endOfTime");if(this.menu)this.level.clearEntity(this.menu.entity);this.tanks.clear(this.level);this.bullets.clear(this.level);this.particles.clear(this.level);this.items.clear(this.level);while(currentTime>=this.updateTime){this.tanks.update(this.level,this.bullets,this.updateTime);this.bullets.update(this.level,this.updateTime);this.items.update(this.tanks,this.updateTime);if((this.updateTime&15)===0){if(this.playback){var applied=this.playback.applyPlayers(this.players);if(!applied)this.pause()}for(var p=0;p<2;p++){if(this.players[p])this.players[p].applyPendings()}if(this.replay)this.replay.processPlayers(this.players)}this.updateTime++}this.particles.update(this.level);this.particles.draw(this.level,0);this.tanks.draw(this.level,Math.max((_global.LEVEL_TIME-currentTime)/_global.LEVEL_TIME,0));this.bullets.draw(this.level);this.particles.draw(this.level,1);this.items.draw(this.level);if(this.menu){this.level.drawEntityBegin(this.menu.entity,this.menu.layer.canvas)}}},{key:"changeMenu",value:function changeMenu(menu){if(this.menu)this.level.clearEntity(this.menu.entity);this.menu=menu}},{key:"pause",value:function pause(){if(this.gameover||this.levelComplete)return;if(this.startPauseTime){this.pauseTime+=Date.now()-this.startPauseTime;this.startPauseTime=0;this.changeMenu(null)}else{this.startPauseTime=Date.now();this.changeMenu(this.pauseMenu)}}},{key:"forcepause",value:function forcepause(){if(this.startPauseTime)return;this.pause()}},{key:"onkeydown",value:function onkeydown(key){if(key==="P".charCodeAt(0))this.pause();if(this.mode==="replay")return;for(var p=0;p<2;p++){if(this.players[p]&&key in keyToAngle[p]){this.players[p].pendingAngle=keyToAngle[p][key];this.players[p].pendingVel=this.players[p].velocity;this.keyMask[p]|=1<<keyToAngle[p][key]}if(this.players[p]&&key===keyShoot[p]){this.players[p].pendingShoot=!this.shootKeyPress[p];this.shootKeyPress[p]=true}}if(this.levelComplete&&key===" ".charCodeAt(0)){this.changeMenu(null);this.update();this.currentLevel=(this.currentLevel+1)%6|0;this.level=null}if(key==="R".charCodeAt(0)&&this.menu&&this.menu.replayCopiedMenu){this.changeMenu(this.menu.replayCopiedMenu);if(this.replay)this.replay.save()}}},{key:"onkeyup",value:function onkeyup(key){if(this.mode==="replay")return;for(var p=0;p<2;p++){if(this.players[p]&&key in keyToAngle[p]){this.keyMask[p]^=1<<keyToAngle[p][key];if(this.keyMask[p]in maskToAngle){this.players[p].pendingAngle=maskToAngle[this.keyMask[p]]}else{this.players[p].pendingVel=0}}if(this.players[p]&&key===keyShoot[p]){this.shootKeyPress[p]=false}}}},{key:"gpAxes",value:function gpAxes(x,y){if(this.mode==="replay")return;if(!this.players[0]||!this.axes)return;var key=[y<-.5,x>.5,y>.5,x<-.5];for(var a=0;a<4;a++){if(this.axes[a]!==key[a]){if(key[a])this.onkeydown(angleToKey[a]);else this.onkeyup(angleToKey[a]);this.axes[a]=key[a]}}}},{key:"gpButton",value:function gpButton(pressed){if(this.mode==="replay")return;if(!this.players[0]||!this.shootKeyPress)return;if(pressed){this.players[0].pendingShoot=!this.shootKeyPress[0];this.shootKeyPress[0]=true}else{this.shootKeyPress[0]=false}}}]);return Game}();exports.default=Game},{"./bullet":1,"./entity":2,"./event":3,"./global":7,"./item":8,"./level":9,"./particle":12,"./replay":13,"./tank":14,"./utils":15}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _utils=require("../utils");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function lerp(a,b,t){return a*(1-t)+b*t}function norm(x){var a=1/Math.sqrt(2*Math.PI);var b=-x*x/2;return a*Math.exp(b)}var SimpleBuffer=function(){function SimpleBuffer(size){_classCallCheck(this,SimpleBuffer);this.data=new Float32Array(size*size);this.size=size}_createClass(SimpleBuffer,[{key:"getData",value:function getData(x,y){if(x<0||x>this.size-1)return 0;if(y<0||y>this.size-1)return 0;return this.data[y*this.size+x|0]}},{key:"setData",value:function setData(x,y,val){if(x<0||x>this.size-1)return;if(y<0||y>this.size-1)return;this.data[y*this.size+x|0]=val}},{key:"getColor",value:function getColor(){var col=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[255,255,255];var mask=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return this.getColor2([0,0,0],col,mask)}},{key:"getColor2",value:function getColor2(){var col0=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[0,0,0];var col1=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[255,255,255];var mask=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;console.assert(!mask||mask.size===this.size,"Require same size");var canvas=document.createElement("canvas");canvas.width=this.size;canvas.height=this.size;var context=canvas.getContext("2d");var imageData=context.createImageData(this.size,this.size);for(var i=0;i<this.size*this.size;i++){imageData.data[4*i+0]=(0,_utils.clamp)(lerp(col0[0],col1[0],this.data[i]),0,255)|0;imageData.data[4*i+1]=(0,_utils.clamp)(lerp(col0[1],col1[1],this.data[i]),0,255)|0;imageData.data[4*i+2]=(0,_utils.clamp)(lerp(col0[2],col1[2],this.data[i]),0,255)|0;imageData.data[4*i+3]=mask?mask.data[i]*255|0:255}context.putImageData(imageData,0,0);return canvas}},{key:"getColorLerp",value:function getColorLerp(img0,img1){var mask=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;console.assert(img0.width===img1.width,"Require same image");console.assert(img0.height===img1.height,"Require same image");console.assert(img0.width===this.size,"Require same image");console.assert(img0.height===this.size,"Require same image");console.assert(!mask||mask.size===this.size,"Require same size");var data0=img0.getContext("2d").getImageData(0,0,this.size,this.size).data;var data1=img1.getContext("2d").getImageData(0,0,this.size,this.size).data;var canvas=document.createElement("canvas");canvas.width=this.size;canvas.height=this.size;var context=canvas.getContext("2d");var imageData=context.createImageData(this.size,this.size);for(var i=0;i<this.size*this.size;i++){imageData.data[4*i+0]=lerp(data0[4*i+0],data1[4*i+0],this.data[i])|0;imageData.data[4*i+1]=lerp(data0[4*i+1],data1[4*i+1],this.data[i])|0;imageData.data[4*i+2]=lerp(data0[4*i+2],data1[4*i+2],this.data[i])|0;imageData.data[4*i+3]=mask?mask.data[i]*255|0:255}context.putImageData(imageData,0,0);return canvas}},{key:"perlin",value:function perlin(startFreq,koef){var _this=this;var extrem=function extrem(freq,ampl){var dispersion=function dispersion(rad){return(0,_utils.mathRand)(0,rad)};var ret=new Array(freq*freq);for(var i=0;i<freq*freq;i++){ret[i]=dispersion(ampl)}return ret};var cosLerp=function cosLerp(a,b,t){var ft=t*Math.PI;var f=(1-Math.cos(ft))*.5;return a*(1-f)+b*f};var ampl=1;var freq=startFreq;var _loop=function _loop(){var buf=extrem(freq,ampl);var bufData=function bufData(x,y){return buf[y*freq+x|0]};for(var j=0;j<_this.size;j++){for(var i=0;i<_this.size;i++){var x=i*freq/_this.size|0;var y=j*freq/_this.size|0;var tx=i*freq/_this.size-x;var ty=j*freq/_this.size-y;var x1=bufData(x,y);var oldX=x;x++;if(x>freq-1)x=0;var x2=bufData(x,y);var xx=cosLerp(x1,x2,tx);y++;if(y>freq-1)y=0;var y1=bufData(oldX,y);var y2=bufData(x,y);var yy=cosLerp(y1,y2,tx);var h=cosLerp(xx,yy,ty);_this.data[_this.size*j+i|0]+=h}}freq*=2;ampl*=koef};do{_loop()}while(freq<this.size);return this}},{key:"normalize",value:function normalize(a,b){var min=this.data[0];var max=this.data[0];for(var i=1;i<this.size*this.size;i++){max=Math.max(max,this.data[i]);min=Math.min(min,this.data[i])}var k=(b-a)/(max-min);for(var _i=0;_i<this.size*this.size;_i++){this.data[_i]=(this.data[_i]-min)*k+a}return this}},{key:"forEach",value:function forEach(fun){for(var j=0;j<this.size;j++){for(var i=0;i<this.size;i++){var ind=j*this.size+i|0;this.data[ind]=fun(this.data[ind],i,j)}}return this}},{key:"forBuf",value:function forBuf(buf,fun){console.assert(this.size===buf.size,"Sizes of buffers must be equal");for(var j=0;j<this.size;j++){for(var i=0;i<this.size;i++){var ind=j*this.size+i|0;this.data[ind]=fun(this.data[ind],buf.data[ind],i,j)}}return this}},{key:"clamp",value:function clamp(a,b){for(var i=0;i<this.size*this.size;i++){this.data[i]=(0,_utils.clamp)(this.data[i],a,b)}return this}},{key:"gaussianFast",value:function gaussianFast(srcBuf,radius,dir){console.assert(this.size===srcBuf.size,"Sizes of buffers must be equal");console.assert(this!==srcBuf,"Source buffer must does not be same with this");for(var j=0;j<this.size;j++){for(var i=0;i<this.size;i++){var kol=0;var sum=0;for(var p=-radius;p<=radius;p++){var x=i+dir[0]*p;var y=j+dir[1]*p;var sx=(x-i)/radius;var sy=(y-j)/radius;var r=Math.sqrt(sx*sx+sy*sy);var koef=norm(r*3);kol+=koef;if(x<0)x+=this.size;if(y<0)y+=this.size;if(x>this.size-1)x-=this.size;if(y>this.size-1)y-=this.size;sum+=koef*srcBuf.data[y*this.size+x|0]}var ind=i+j*this.size|0;this.data[ind]=sum/kol}}}},{key:"gaussian",value:function gaussian(radius){if(radius<1)return this;var blur=new SimpleBuffer(this.size);blur.gaussianFast(this,radius,[1,0]);this.gaussianFast(blur,radius,[0,1]);return this}},{key:"copy",value:function copy(src){console.assert(this.size===src.size,"Sizes of buffers must be equal");console.assert(this!==src,"Source buffer must does not be same with this");for(var i=0;i<this.size*this.size;i++){this.data[i]=src.data[i]}return this}},{key:"bresenham",value:function bresenham(x0,y0,x1,y1,val){var dx=Math.abs(x1-x0);var dy=Math.abs(y1-y0);var sx=x0<x1?1:-1;var sy=y0<y1?1:-1;var err=(dx>dy?dx:-dy)/2;var x=x0;var y=y0;for(;;){this.setData(x,y,val);if(x===x1&&y===y1)break;var e2=err;if(e2>-dx){err-=dy;x+=sx}if(e2<dy){err+=dx;y+=sy}}return this}},{key:"differential",value:function differential(fun){for(var j=0;j<this.size;j++){for(var i=0;i<this.size;i++){var nx=i+1;var ny=j+1;if(nx>this.size-1)nx=0;if(ny>this.size-1)ny=0;var ind00=j*this.size+i;var ind01=ny*this.size+i;var ind10=j*this.size+nx;var col00=this.data[ind00];var col01=this.data[ind01];var col10=this.data[ind10];var dx=(col10-col00)*.5;var dy=(col01-col00)*.5;fun(ind00,dx,dy)}}}},{key:"diff",value:function diff(dir){var _this2=this;var buf=new SimpleBuffer(this.size);buf.copy(this);buf.differential(function(ind,dx,dy){_this2.data[ind]=dx*dir[0]+dy*dir[1]});return this}},{key:"diffFree",value:function diffFree(){var _this3=this;var buf=new SimpleBuffer(this.size);buf.copy(this);buf.differential(function(ind,dx,dy){_this3.data[ind]=Math.sqrt(dx*dx+dy*dy)});return this}},{key:"brick",value:function brick(countWidth,countHeight){var alternat=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var brickWidth=this.size/countWidth;var brickHeight=this.size/countHeight;for(var brickY=0;brickY<countHeight;brickY++){var startX=brickY%2|0&&alternat?-brickWidth*.5|0:0;var startY=brickY*brickHeight|0;for(var brickX=0;brickX<countWidth;brickX++){var color=Math.random();var X=startX+brickX*brickWidth|0;for(var j=startY;j<startY+brickHeight;j++){if(j>this.size-1)break;for(var i=X;i<X+brickWidth;i++){var x=i<0?this.size+i:i;this.data[j*this.size+x]=color}}}}return this}},{key:"brickMask",value:function brickMask(countWidth,countHeight){var alternat=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var brickWidth=this.size/countWidth;var brickHeight=this.size/countHeight;for(var brickY=0;brickY<countHeight;brickY++){var y=brickY*brickHeight|0;var startX=brickY%2|0&&alternat?-brickWidth*.5|0:0;this.bresenham(0,y,this.size,y,1);for(var brickX=0;brickX<countWidth;brickX++){var x=startX+brickX*brickWidth|0;if(x<0)x+=this.size;this.bresenham(x,y,x,y+brickHeight|0,1)}}return this}},{key:"normDist",value:function normDist(rad){var dx=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var dy=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;for(var j=0;j<this.size;j++){for(var i=0;i<this.size;i++){var x=((i-this.size*.5)/(this.size*.5)+dx)/rad;var y=((j-this.size*.5)/(this.size*.5)+dy)/rad;var r=Math.sqrt(x*x+y*y);var koef=norm(r*3);this.data[j*this.size+i]=koef}}return this}},{key:"normSquare",value:function normSquare(minRad,rad){for(var j=0;j<this.size;j++){for(var i=0;i<this.size;i++){var x=(i-this.size*.5)/(this.size*.5);var y=(j-this.size*.5)/(this.size*.5);var r=0;if(Math.abs(x)>minRad&&Math.abs(y)>minRad){var sx=Math.abs(x)-minRad;var sy=Math.abs(y)-minRad;r=Math.sqrt(sx*sx+sy*sy)}else if(Math.abs(x)>minRad)r=Math.abs(x)-minRad;else if(Math.abs(y)>minRad)r=Math.abs(y)-minRad;r/=rad;var koef=norm(r*3);this.data[j*this.size+i]=koef}}return this}}]);return SimpleBuffer}();exports.default=SimpleBuffer},{"../utils":15}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _buffer=require("./buffer");var _buffer2=_interopRequireDefault(_buffer);var _utils=require("../utils");var _global=require("../global");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var GenTextures=function GenTextures(tileSize){var _this=this,_colors,_tankBodies$,_tankTurret$,_tankTurretEx$,_tankTrack$,_item,_smokes,_itemText;_classCallCheck(this,GenTextures);var step=tileSize*.2|0;var ground=new _buffer2.default(tileSize*8);this.ground=ground.perlin(5,.9).normalize(.7,1).getColor((0,_utils.randColor)([150,133,84],20));var cement=new _buffer2.default(tileSize*8);var cementImg=cement.perlin(5,.5).diff([1,.5]).diff([-.5,1]).normalize(.5,1).getColor((0,_utils.randColor)([200,200,200]));var noise=new _buffer2.default(tileSize*8);noise.perlin(5,.5).diff([1,.5]).normalize(.6,1.4);var brick=new _buffer2.default(tileSize*8);var brickImg=brick.brick(16,32).normalize(.7,1).forBuf(noise,function(a,b){return a*b}).getColor((0,_utils.randColor)([200,80,60]));var brickMask=new _buffer2.default(tileSize*8);this.brick=brickMask.brickMask(16,32).gaussian(step*.25|0).clamp(.1,.3).normalize(0,1).getColorLerp(brickImg,cementImg);var betonNoise=new _buffer2.default(tileSize*8);betonNoise.perlin(5,.5).forEach(function(a){return a*a}).diffFree().normalize(.6,1);var beton=new _buffer2.default(tileSize*8);var betonImg=beton.brick(8,8,false).normalize(.6,1).forBuf(betonNoise,function(a,b){return a*b}).getColor((0,_utils.randColor)([160,160,160]));var betonMask=new _buffer2.default(tileSize*8);this.beton=betonMask.brickMask(8,8,false).gaussian(step*.5|0).clamp(.1,.3).normalize(0,1).getColorLerp(betonImg,cementImg);var halfTileMask=new _buffer2.default(tileSize*8);halfTileMask.brickMask(8,8,false).gaussian(step).normalize(3,-1).clamp(0,1);var halfMask=new _buffer2.default(tileSize*8);halfMask.perlin(20,.7).forEach(Math.abs).normalize(0,3).clamp(0,1).forBuf(halfTileMask,function(a,b){return a*b});var half=new _buffer2.default(tileSize*8).copy(halfMask).forEach(function(a){return a*a*a});var black=new _buffer2.default(tileSize*8).getColor();this.halfBrick=half.getColorLerp(black,this.brick,halfMask);this.halfBeton=half.getColorLerp(black,this.beton,halfMask);var lava=new _buffer2.default(tileSize*8);this.lava=lava.perlin(10,.5).normalize(0,30).forEach(Math.cos).normalize(.5,1).getColor2((0,_utils.randColor)([255,0,0]),(0,_utils.randColor)([255,255,0]));this.lavaMask=new Array(8);this.lavaLightMask=new Array(8);for(var i=0;i<this.lavaMask.length;i++){var lavaNoise=new _buffer2.default(tileSize*2);lavaNoise.perlin(5,.5);var lavaMask=new _buffer2.default(tileSize*2);this.lavaMask[i]=lavaMask.normSquare(.4,.5).normalize(0,1).forBuf(lavaNoise,function(a,b){return a+.25*b}).clamp(.4,.6).normalize(0,1).getColor([255,255,255],lavaMask);var lavaLightMask=new _buffer2.default(tileSize*2);this.lavaLightMask[i]=lavaLightMask.normSquare(.4,.5).normalize(0,1.5).forBuf(lavaNoise,function(a,b){return a+.25*b}).clamp(.25,.75).gaussian(step*2).normalize(0,1).getColor([200,200,200],lavaLightMask)}var grass=new _buffer2.default(tileSize*8);this.grass=grass.perlin(5,.5).diffFree().normalize(.7,1.3).getColor((0,_utils.randColor)([49,107,54]));this.grassMask=new Array(8);for(var _i=0;_i<this.grassMask.length;_i++){var normDist=new _buffer2.default(tileSize*2);normDist.normDist(1.25).normalize(0,3).clamp(0,1);var grassMask=new _buffer2.default(tileSize*2);this.grassMask[_i]=grassMask.perlin(20,.9).normalize(0,1).forBuf(normDist,function(a,b){return a*b}).clamp(.25,.45).normalize(0,1).getColor((0,_utils.randColor)([255,255,255]),grassMask)}var boardMask=new _buffer2.default(tileSize);boardMask.forEach(function(){return 1}).bresenham(0,0,boardMask.size-1,0,0).bresenham(0,boardMask.size-1,boardMask.size-1,boardMask.size-1,0).bresenham(0,0,0,boardMask.size-1,0).bresenham(boardMask.size-1,0,boardMask.size-1,boardMask.size-1,0).gaussian(2);var board=new _buffer2.default(tileSize);this.board=board.perlin(2,.5).normalize(.7,1).forBuf(boardMask,function(a,b){return a*b}).getColor((0,_utils.randColor)([188,198,204]));var eagle=new _buffer2.default(tileSize*2);var center=eagle.size*.5|0;eagle.bresenham(center,center+step,2*step,2*step,1).bresenham(center,center+step,eagle.size-2*step,2*step,1).bresenham(center,step,center,eagle.size-step,1).bresenham(center-2*step,center+2*step,3*step,3*step,1).bresenham(center+2*step,center+2*step,eagle.size-3*step,3*step,1).bresenham(center-2*step,center+2*step,center,center,1).bresenham(center+2*step,center+2*step,center,center,1).gaussian(step).normalize(0,1).bresenham(center,eagle.size-2*step,center-2*step,eagle.size-step,1.5).bresenham(center,eagle.size-2*step,center+2*step,eagle.size-step,1.5).bresenham(center-step,step,center,step,1).bresenham(center,step*1.5|0,center+step*1.5|0,step*1.5|0,1).bresenham(step*2,step*2,step,step,1.5).bresenham(eagle.size-step*2,step*2,eagle.size-step,step,1.5).bresenham(3*step,3*step,step,3*step,1).bresenham(eagle.size-3*step,3*step,eagle.size-step,3*step,1).bresenham(4*step,4*step,step,4*step,1).bresenham(eagle.size-4*step,4*step,eagle.size-step,4*step,1).gaussian(step).normalize(0,1);var eagleMask=new _buffer2.default(eagle.size);eagleMask.copy(eagle).clamp(.1,.2).normalize(0,1);var eagleColor=new _buffer2.default(eagle.size);this.eagle=eagleColor.forEach(function(){return 1}).bresenham(center,step,center,step,0).gaussian(step).normalize(0,1).clamp(.2,.25).normalize(0,1).forBuf(eagleMask,function(a,b){return a*(5*(Math.abs(b-.5)-.5)+1)}).forBuf(eagle,function(a,b){return a+b*.5}).getColor2([0,0,0],[128,128,128],eagleMask);var transformImage=function transformImage(image,callback){var canvas=document.createElement("canvas");var context=canvas.getContext("2d");canvas.width=image.width;canvas.height=image.height;context.save();context.translate(image.width*.5,image.height*.5);callback(context);context.translate(-image.width*.5,-image.height*.5);context.drawImage(image,0,0);context.restore();return canvas};var rotateImage=function rotateImage(image,angle){return transformImage(image,function(context){return context.rotate(Math.PI*.5*angle)})};var scaleImage=function scaleImage(image,vec){return transformImage(image,function(context){return context.scale(vec[0],vec[1])})};this.bridgeV=new Array(8);var _loop=function _loop(k){var bridgeMask=new _buffer2.default(tileSize*2);bridgeMask.perlin(5,.5).forEach(function(a,i,j){var x=(i/bridgeMask.size-.5)*2;var y=(j/bridgeMask.size-.5)*2;var factorX=Math.abs(x)<.4?1:0;var factorY=(0,_utils.clamp)(2-2*Math.abs(y),0,1);factorY+=.25*a;factorY=((0,_utils.clamp)(factorY,.3,.4)-.3)*10;return factorX*factorY});var bridge=new _buffer2.default(tileSize*2);_this.bridgeV[k]=bridge.perlin(5,.5).forEach(function(a){return a*a}).diffFree().normalize(.5,1.5).forEach(function(a,i){var x=i/bridge.size*Math.PI*8;return a*Math.abs(Math.cos(x))}).forBuf(bridgeMask,function(a,b){return a*b*b}).normalize(.5,1).getColor([182,155,76],bridgeMask)};for(var k=0;k<this.bridgeV.length;k++){_loop(k)}this.bridgeH=[];this.bridgeV.forEach(function(bridge){return _this.bridgeH.push(rotateImage(bridge,1))});var createTrack=function createTrack(size,offset,isWheel){var trackMask=new _buffer2.default(tileSize*2);trackMask.forEach(function(a,i,j){var x=(i/trackMask.size-.5)*2;var y=(j/trackMask.size-.5)*2;var factorX=Math.abs(x)<size?1:0;factorX*=Math.abs(x)<.5?0:1;var factorY=Math.abs(y)<size?1:0;var wheel=j/trackMask.size*Math.PI*3;wheel=Math.abs(Math.sin(wheel));wheel=wheel<.5&&isWheel?0:1;factorY*=wheel;return factorX*factorY});var track=new _buffer2.default(tileSize*2);return track.forEach(function(a,i,j){var y=j/track.size*Math.PI*10;return Math.abs(Math.cos(y+Math.PI*offset))}).normalize(.5,1).getColor(isWheel?[80,80,80]:[160,160,160],trackMask)};var smoothedSquare=function smoothedSquare(buffer,width,height){buffer.forEach(function(a,i,j){var x=(i/buffer.size-.5)*2;var y=(j/buffer.size-.5)*2;var factorX=Math.abs(x)<width?1:0;var factorY=Math.abs(y)<height?1:0;return factorX*factorY}).gaussian(step);return buffer};var createCorpus=function createCorpus(size,color){var width=arguments.length>2&&arguments[2]!==undefined?arguments[2]:.6;var corpusMask=new _buffer2.default(tileSize*2);smoothedSquare(corpusMask,width,size).clamp(.5,.6).normalize(0,1);var corpus=new _buffer2.default(tileSize*2);return corpus.brick(10,10).diff([1,.5]).normalize(0,1).forEach(function(a,i,j){var y=(j/corpus.size-.5)*2;if(Math.abs(y)<size*.5)return a;var k=(0,_utils.clamp)((size-Math.abs(y))/(size*.5),0,1);return a*Math.sqrt(k)}).normalize(.25,1).getColor(color,corpusMask)};var createTurret=function createTurret(size,barrelWidth,barrelLength,color){var barrelMask=new _buffer2.default(tileSize*2);smoothedSquare(barrelMask,barrelWidth,barrelLength).clamp(.5,.6).normalize(0,1).forEach(function(a,i,j){return j<barrelMask.size*.5?a:0});var barrel=new _buffer2.default(tileSize*2);var barrelImg=smoothedSquare(barrel,barrelWidth,barrelLength).diff([1,.5]).normalize(.25,1).getColor([220,220,220],barrelMask);var turretMask=new _buffer2.default(tileSize*2);turretMask.normDist(size).clamp(.1,.15).normalize(0,1);var turret=new _buffer2.default(tileSize*2);var turretImg=turret.normDist(size).diff([1,.5]).normalize(.25,1).forBuf(turretMask,function(a,b){return a*(Math.abs(b-.5)+.5)}).getColor(color,turretMask);var ctx=barrelImg.getContext("2d");ctx.drawImage(turretImg,0,0);return barrelImg};var colors=(_colors={},_defineProperty(_colors,_global.TANK.TANK1,[200,150,100]),_defineProperty(_colors,_global.TANK.TANK2,[100,150,200]),_defineProperty(_colors,_global.TANK.SIMPLE,[120,200,120]),_defineProperty(_colors,_global.TANK.BMP,[200,200,200]),_defineProperty(_colors,_global.TANK.CANNON,[250,230,134]),_defineProperty(_colors,_global.TANK.STRONG,[100,200,180]),_defineProperty(_colors,_global.TANK.PANZER,[211,229,224]),_colors);var zombieColor=[238,30,30];this.tankBodies=new Array(4);this.tankTurret=new Array(4);this.tankTurretEx=new Array(4);this.tankTurretFF=new Array(4);this.tankTrack=new Array(4);this.tankBodies[0]=(_tankBodies$={},_defineProperty(_tankBodies$,_global.TANK.TANK1,createCorpus(.7,colors[_global.TANK.TANK1])),_defineProperty(_tankBodies$,_global.TANK.TANK2,createCorpus(.7,colors[_global.TANK.TANK2])),_defineProperty(_tankBodies$,_global.TANK.SIMPLE,createCorpus(.5,colors[_global.TANK.SIMPLE])),_defineProperty(_tankBodies$,_global.TANK.BMP,createCorpus(.7,colors[_global.TANK.BMP],.5)),_defineProperty(_tankBodies$,_global.TANK.CANNON,createCorpus(.5,colors[_global.TANK.CANNON])),_defineProperty(_tankBodies$,_global.TANK.STRONG,createCorpus(.75,colors[_global.TANK.STRONG])),_defineProperty(_tankBodies$,_global.TANK.PANZER,createCorpus(1,colors[_global.TANK.PANZER])),_tankBodies$);this.tankTurret[0]=(_tankTurret$={},_defineProperty(_tankTurret$,_global.TANK.TANK1,createTurret(.7,.1,.7,colors[_global.TANK.TANK2])),_defineProperty(_tankTurret$,_global.TANK.TANK2,createTurret(.7,.1,.7,colors[_global.TANK.TANK1])),_defineProperty(_tankTurret$,_global.TANK.SIMPLE,createTurret(.7,.1,.7,colors[_global.TANK.SIMPLE])),_defineProperty(_tankTurret$,_global.TANK.BMP,createTurret(.4,.1,.6,colors[_global.TANK.BMP])),_defineProperty(_tankTurret$,_global.TANK.CANNON,createTurret(.7,.1,1,colors[_global.TANK.CANNON])),_defineProperty(_tankTurret$,_global.TANK.STRONG,createTurret(.7,.1,.7,colors[_global.TANK.STRONG])),_defineProperty(_tankTurret$,_global.TANK.PANZER,createTurret(1,.2,1,colors[_global.TANK.PANZER])),_tankTurret$);this.tankTurretEx[0]=(_tankTurretEx$={},_defineProperty(_tankTurretEx$,_global.TANK.TANK1,createTurret(.7,.1,1,colors[_global.TANK.TANK2])),_defineProperty(_tankTurretEx$,_global.TANK.TANK2,createTurret(.7,.1,1,colors[_global.TANK.TANK1])),_tankTurretEx$);this.tankTurretFF[0]=createTurret(.7,.1,.7,zombieColor);var countAnimTrack=8;var trackSimple=new Array(countAnimTrack);var trackBMP=new Array(countAnimTrack);var trackPanzer=new Array(countAnimTrack);for(var offset=0;offset<countAnimTrack;offset++){trackSimple[offset]=createTrack(.8,offset/countAnimTrack,false);trackBMP[offset]=createTrack(.8,offset/countAnimTrack,true);trackPanzer[offset]=createTrack(1,offset/countAnimTrack,false)}this.tankTrack[0]=(_tankTrack$={},_defineProperty(_tankTrack$,_global.TANK.TANK1,trackSimple),_defineProperty(_tankTrack$,_global.TANK.TANK2,trackSimple),_defineProperty(_tankTrack$,_global.TANK.SIMPLE,trackSimple),_defineProperty(_tankTrack$,_global.TANK.BMP,trackBMP),_defineProperty(_tankTrack$,_global.TANK.CANNON,trackSimple),_defineProperty(_tankTrack$,_global.TANK.STRONG,trackSimple),_defineProperty(_tankTrack$,_global.TANK.PANZER,trackPanzer),_tankTrack$);for(var _i2=1;_i2<4;_i2++){this.tankBodies[_i2]={};this.tankTurret[_i2]={};this.tankTurretEx[_i2]={};this.tankTurretFF[_i2]={};this.tankTrack[_i2]={};for(var type=_global.TANK.TANK1;type<_global.TANK.RANDOM;type++){this.tankBodies[_i2][type]=rotateImage(this.tankBodies[0][type],_i2);this.tankTurret[_i2][type]=rotateImage(this.tankTurret[0][type],_i2);this.tankTrack[_i2][type]=new Array(countAnimTrack);for(var _offset=0;_offset<countAnimTrack;_offset++){this.tankTrack[_i2][type][_offset]=rotateImage(this.tankTrack[0][type][_offset],_i2)}}this.tankTurretEx[_i2][_global.TANK.TANK1]=rotateImage(this.tankTurretEx[0][_global.TANK.TANK1],_i2);this.tankTurretEx[_i2][_global.TANK.TANK2]=rotateImage(this.tankTurretEx[0][_global.TANK.TANK2],_i2);this.tankTurretFF[_i2]=rotateImage(this.tankTurretFF[0],_i2)}var bulletMask=new _buffer2.default(tileSize);bulletMask.normDist(1).clamp(.1,.2).normalize(0,1);var bullet=new _buffer2.default(tileSize);this.bullet=bullet.normDist(1).diff([1,.5]).normalize(.5,1).forBuf(bulletMask,function(a,b){return a*(5*(Math.abs(b-.5)-.5)+1)}).getColor([255,255,255],bulletMask);var createFire=function createFire(size){var koef=tileSize/size;var plume=new _buffer2.default(size);for(var _i3=0;_i3<size*.75|0;_i3++){var plumeStep=new _buffer2.default(size);plumeStep.normDist(koef*.75-koef*.75*_i3/(size*.75),0,.5-2*_i3/size);plume.forBuf(plumeStep,function(a,b){return a+b})}plume.normalize(0,1);var fire=new _buffer2.default(size);return fire.normDist(koef,0,.5).clamp(.1,.5).normalize(0,1).forBuf(plume,function(a,b){return a+b}).normalize(0,2).getColor2([255,0,0],[255,255,127],fire)};this.fireSmall=new Array(4);this.fireLong=new Array(4);this.fireLong[0]=createFire(tileSize*2);this.fireSmall[0]=createFire(tileSize);for(var _i4=1;_i4<4;_i4++){this.fireLong[_i4]=rotateImage(this.fireLong[0],_i4);this.fireSmall[_i4]=rotateImage(this.fireSmall[0],_i4)}var shieldMask=new _buffer2.default(tileSize*3);shieldMask.forEach(function(a,i,j){var x=(i/shieldMask.size-.5)*2;var y=(j/shieldMask.size-.5)*2;var factorX=25/16*x*x;var factorY=25/16*y*y;var ret=Math.max(factorX,factorY);return ret<1?ret:0}).gaussian(step*2).normalize(0,1);var createShield=function createShield(){var offsetX=new _buffer2.default(tileSize*3);offsetX.perlin(2,.5);var offsetY=new _buffer2.default(tileSize*3);offsetY.perlin(2,.5);var shield=new _buffer2.default(tileSize*3);return shield.forEach(function(a,i,j){var x=(i/shieldMask.size-.5)*2;var y=(j/shieldMask.size-.5)*2;var factorX=1-25/16*x*x;var factorY=1-25/16*y*y;var dx=offsetX.getData(i,j);var dy=offsetY.getData(i,j);var tx=(0,_utils.clamp)(i+dx*step*factorY,0,shieldMask.size)|0;var ty=(0,_utils.clamp)(j+dy*step*factorX,0,shieldMask.size)|0;return shieldMask.getData(tx,ty)}).getColor([255,255,512],shield)};this.shield=[];for(var _i5=0;_i5<8;_i5++){this.shield.push(createShield())}var respawn=new _buffer2.default(tileSize*2);var countAnimRespawn=8;this.respawn=new Array(countAnimRespawn);this.respawn[0]=respawn.forEach(function(a,i,j){var x=(i/respawn.size-.5)*2;var y=(j/respawn.size-.5)*2;return 1/(Math.abs(x)+Math.abs(y)+1)-.5}).clamp(0,1).gaussian(step).normalize(0,1).getColor([255,512,255],respawn);for(var _i6=1;_i6<countAnimRespawn;_i6++){var koef=.3*Math.sin(_i6/countAnimRespawn*Math.PI*2);this.respawn[_i6]=scaleImage(this.respawn[0],[1+koef,1-koef])}var itemTemplateMask=new _buffer2.default(tileSize*2);itemTemplateMask.forEach(function(a,i,j){var x=(i/itemTemplateMask.size-.5)*2;var y=(j/itemTemplateMask.size-.5)*2;var factorX=.5;var factorY=.5;if(Math.abs(x)>.7&&Math.abs(x)<.8||Math.abs(y)>.7&&Math.abs(y)<.8){factorX=1;factorY=1}if(Math.abs(x)>.8)factorX=0;if(Math.abs(y)>.8)factorY=0;return Math.min(factorX,factorY)}).gaussian(step).clamp(.45,.55).normalize(0,1);var itemTemplate=new _buffer2.default(tileSize*2);itemTemplate.forEach(function(a,i,j){var x=(i/itemTemplate.size-.5)*2;var y=(j/itemTemplate.size-.5)*2;var factorX=Math.abs(x)>.7&&Math.abs(x)<.8?1:0;var factorY=Math.abs(y)>.7&&Math.abs(y)<.8?1:0;return factorX+factorY}).gaussian(step).normalize(0,2).clamp(0,1).normalize(0,1.5);var getItemTemplateImg=function getItemTemplateImg(){return itemTemplate.getColor([127,174,249],itemTemplateMask)};var itemFire=getItemTemplateImg();itemFire.getContext("2d").drawImage(this.fireSmall[0],tileSize*.5,tileSize*.5);var zombie=new _buffer2.default(tileSize*2);for(var _i7=0;_i7<zombie.size/8|0;_i7++){var s=zombie.size/4|0;var e=zombie.size-s;var w=zombie.size*9/40|0;for(var j=0;j<2;j++){var d=j*(e-s-w);zombie.bresenham(s+_i7+d,s,s+_i7+d,e,1);zombie.bresenham(s+d,s+_i7,s+w+d,s+_i7,1);zombie.bresenham(s+d,s+w+_i7,s+w+d,s+w+_i7,1)}}zombie.gaussian(2).normalize(0,1);var itemZombie=getItemTemplateImg();itemZombie.getContext("2d").drawImage(zombie.getColor(zombieColor,zombie),0,0);var speed=new _buffer2.default(tileSize*2);this.speedImg=speed.forEach(function(a,i,j){var x=(i/itemTemplate.size-.5)*2;var y=(j/itemTemplate.size-.5)*2;var arrow=-y+Math.sqrt(3)*Math.abs(x)<.5?1:0;arrow*=y<0?1:0;var factorX=Math.abs(x)<.125?1:0;var factorY=y>=0&&y<.5?1:0;return arrow+factorX*factorY}).gaussian(2).normalize(0,1).getColor([127,174,249],speed);var itemSpeed=getItemTemplateImg();itemSpeed.getContext("2d").drawImage(this.speedImg,0,0);var knukleCoord=[[.7,.53,.7,.33,1],[.6,.55,.6,.28,1],[.5,.53,.5,.23,1],[.4,.355,.4,.255,1],[.425,.43,.3,.43,1],[.3,.43,.3,.58,1.5],[.3,.63,.5,.73,2],[.3,.58,.6,.68,2],[.5,.73,.72,.61,2],[.5,.73,.7,.65,2]];var knukle=new _buffer2.default(tileSize*2);knukleCoord.forEach(function(coord){var x1=coord[0]*knukle.size|0;var y1=coord[1]*knukle.size|0;var x2=coord[2]*knukle.size|0;var y2=coord[3]*knukle.size|0;var val=coord[4];knukle.bresenham(x1,y1,x2,y2,val)});var knukleImg=knukle.gaussian(step*.5|0).clamp(0,.1).normalize(0,1).getColor([231,215,242],knukle);var itemKnukle=getItemTemplateImg();itemKnukle.getContext("2d").drawImage(knukleImg,0,0);var createStar=function createStar(){var getStar5=function getStar5(number,x,y){var sina=Math.sin(Math.PI*.4*number);var cosa=Math.cos(Math.PI*.4*number);var X=x*cosa-y*sina;var Y=y*cosa+x*sina;var star5=.6+Y-Math.abs(X)/Math.tan(Math.PI*.1);star5*=Y<=0?1:0;return star5};return new _buffer2.default(tileSize*2).forEach(function(a,i,j){var x=(i/itemTemplate.size-.5)*2;var y=(j/itemTemplate.size-.5)*2;var star5=getStar5(0,x,y);for(var n=1;n<5;n++){star5=Math.max(star5,getStar5(n,x,y))}return star5})};var starMask=createStar().normalize(0,20).clamp(0,1).gaussian(step*.5|0).clamp(.1,.2).normalize(0,1);this.starImg=createStar().diff([1,1]).normalize(0,2).gaussian(step*.5|0).getColor([239,230,155],starMask);var itemStar=getItemTemplateImg();itemStar.getContext("2d").drawImage(this.starImg,0,0);var life=new _buffer2.default(tileSize*2);life.forEach(function(a,i,j){var x=(i/life.size-.5)*2;var y=(j/life.size-.5)*2;var trackX=Math.abs(x)<.5?1:0;var trackY=y>.1&&y<.3?1:0;var turretX=Math.abs(x)<.15?1:0;var turretY=y>-.3&&y<.2?1:0;return turretX*turretY+trackX*trackY}).gaussian(step).clamp(.1,.3).normalize(0,1).bresenham(tileSize,tileSize-step,tileSize*1.5|0,tileSize-step,1).bresenham(tileSize,tileSize-step+1,tileSize*1.5|0,tileSize-step+1,1).bresenham(tileSize,tileSize-step+2,tileSize*1.5|0,tileSize-step+2,1).forEach(function(a,i,j){var x=(i/life.size-.5)*2;var y=(j/life.size-.5)*2;var circle=function circle(cx,cy){var dx=x-cx;var dy=y-cy;return Math.sqrt(dx*dx+dy*dy)<.1?0:1};return a*circle(-.33,.2)*circle(0,.2)*circle(.33,.2)});var lifeColor=new _buffer2.default(tileSize*2);this.lifeImg=lifeColor.copy(life).gaussian(step).diff([1,.5]).normalize(.5,1.5).getColor([190,190,190],life);var itemLife=getItemTemplateImg();itemLife.getContext("2d").drawImage(this.lifeImg,0,0);this.item=(_item={},_defineProperty(_item,_global.ITEM.LIFE,itemLife),_defineProperty(_item,_global.ITEM.KNUKLE,itemKnukle),_defineProperty(_item,_global.ITEM.ZOMBIE,itemZombie),_defineProperty(_item,_global.ITEM.STAR,itemStar),_defineProperty(_item,_global.ITEM.SPEED,itemSpeed),_defineProperty(_item,_global.ITEM.FIREBALL,itemFire),_item);var createDecal=function createDecal(){var decal=new _buffer2.default(tileSize*3);var halfSize=decal.size*.5|0;decal.normDist(1);for(var angle=0;angle<Math.PI*2;angle+=Math.PI/30){var x=halfSize+Math.cos(angle)*(0,_utils.mathRand)(halfSize*.75,halfSize*.25)|0;var y=halfSize+Math.sin(angle)*(0,_utils.mathRand)(halfSize*.75,halfSize*.25)|0;decal.bresenham(halfSize,halfSize,x,y,1)}return decal.gaussian(step).clamp(0,.5).normalize(0,.5).getColor([0,0,0],decal)};this.decals=[];var COUNT_DECALS=5;for(var _i8=0;_i8<COUNT_DECALS;_i8++){this.decals.push(createDecal())}for(var _i9=0;_i9<16;_i9++){var angle=Math.random()*4;var ind=Math.random()*COUNT_DECALS|0;this.decals.push(rotateImage(this.decals[ind],angle))}function createSpark(fireball){var COUNT_FRAMES=fireball?10:32;var COUNT_PART=fireball?5:16;var SIZE=tileSize*(fireball?2:4);var ret=[];var pos=new Array(COUNT_PART);var vel=new Array(COUNT_PART);for(var _i10=0;_i10<COUNT_PART;_i10++){var sx=(0,_utils.mathRand)(0,1/COUNT_FRAMES);var sy=(0,_utils.mathRand)(0,1/COUNT_FRAMES);var px=fireball?0:(0,_utils.mathRand)(0,.25);var py=fireball?0:(0,_utils.mathRand)(0,.25);pos[_i10]=[px,py];vel[_i10]=[sx,sy]}var bufPrevFrame=null;for(var _i11=0;_i11<COUNT_FRAMES;_i11++){var buf=new _buffer2.default(SIZE);var factor=1-_i11/COUNT_FRAMES;if(bufPrevFrame){buf.forBuf(bufPrevFrame,function(a,b){return b*(fireball?.9:1)})}for(var _j=0;_j<COUNT_PART;_j++){var x=pos[_j][0];var y=pos[_j][1];var radius=fireball?.25:.5*factor;var bufPart=new _buffer2.default(SIZE);bufPart.normDist(radius,x,y);buf.forBuf(bufPart,function(a,b){return a+b});pos[_j][0]+=vel[_j][0];pos[_j][1]+=vel[_j][1]}buf.normalize(0,(fireball?2:5)*factor);bufPrevFrame=buf;ret.push(buf)}return ret}this.sparksFire=new Array(16);var COUNT_GENERATED_SPARKS=4;var _loop2=function _loop2(_i12){var sparks=createSpark(true);_this.sparksFire[_i12]=[];sparks.forEach(function(spark){_this.sparksFire[_i12].push(spark.getColor2([255,0,0],[255,255,127],spark))})};for(var _i12=0;_i12<COUNT_GENERATED_SPARKS;_i12++){_loop2(_i12)}var _loop3=function _loop3(_i13){_this.sparksFire[_i13]=[];var angle=Math.random()*4;var ind=Math.random()*COUNT_GENERATED_SPARKS|0;_this.sparksFire[ind].forEach(function(spark){return _this.sparksFire[_i13].push(rotateImage(spark,angle))})};for(var _i13=COUNT_GENERATED_SPARKS;_i13<this.sparksFire.length;_i13++){_loop3(_i13)}this.sparksBullet=new Array(10);for(var _i14=0;_i14<this.sparksBullet.length;_i14++){var sparkMask=new _buffer2.default(tileSize*.5|0);sparkMask.normDist(1).clamp(.1,.3).normalize(0,1);var spark=new _buffer2.default(tileSize*.5|0);spark.normDist(1).diff([1,.5]).normalize(.5,1).forBuf(sparkMask,function(a,b){return a*(5*(Math.abs(b-.5)-.5)+1)});sparkMask.normalize(0,1-_i14/this.sparksBullet.length);this.sparksBullet[_i14]=spark.getColor([255,255,255],sparkMask)}var createSparkBrickBeton=function createSparkBrickBeton(color){var createSparkBrick=function createSparkBrick(size){var offsetX=new _buffer2.default(tileSize*.5|0);offsetX.perlin(2,.5);var offsetY=new _buffer2.default(tileSize*.5|0);offsetY.perlin(2,.5);var sparkBrickMask=new _buffer2.default(tileSize*.5|0);sparkBrickMask.normDist(size).normalize(0,1).clamp(.1,.3).normalize(0,1);var sparkNoise=new _buffer2.default(tileSize*.5|0);sparkNoise.perlin(5,.5).diff([1,.5]).normalize(.6,1.4);var random=(0,_utils.mathRand)(.8,.2);var spark=new _buffer2.default(tileSize*.5|0);spark.forEach(function(a,i,j){var dx=offsetX.getData(i,j);var dy=offsetY.getData(i,j);var tx=(0,_utils.clamp)(i+dx*step*.4,0,sparkBrickMask.size)|0;var ty=(0,_utils.clamp)(j+dy*step*.4,0,sparkBrickMask.size)|0;return sparkBrickMask.getData(tx,ty)});return new _buffer2.default(tileSize*.5|0).forBuf(spark,function(a,b){return b*random}).forBuf(sparkNoise,function(a,b){return a*b}).getColor((0,_utils.randColor)(color),spark)};var ret=[];for(var _i15=0;_i15<10;_i15++){ret[_i15]=[];ret[_i15].push(createSparkBrick(_i15/10));var COUNT_ANGLES=32;for(var _angle=1;_angle<COUNT_ANGLES;_angle++){ret[_i15].push(rotateImage(ret[_i15][0],_angle/COUNT_ANGLES*4))}}return ret};this.sparksBrick=createSparkBrickBeton([200,80,60]);this.sparksBeton=createSparkBrickBeton([160,160,160]);var createSmoke=function createSmoke(lvl){var ret=new Array(16);for(var _i16=0;_i16<ret.length;_i16++){var smokeNoise=new _buffer2.default(tileSize);smokeNoise.perlin(2,.5).forEach(Math.abs);var _koef=.25*(lvl+1);var factor=_i16/ret.length;var smoke=new _buffer2.default(tileSize);smoke.normDist(1.5).normalize(0,1).forBuf(smokeNoise,function(a,b){return a*b}).normalize(0,_koef*(0,_utils.clamp)(1.5-1.5*factor,0,1));if(_i16===0&&lvl===3){ret[_i16]=smoke.getColor2([255,0,0],[255,255,127],smoke)}else{ret[_i16]=smoke.getColor([190,190,190],smoke)}}return ret};this.smokes=(_smokes={},_defineProperty(_smokes,_global.PART.SMOKE0,createSmoke(0)),_defineProperty(_smokes,_global.PART.SMOKE1,createSmoke(1)),_defineProperty(_smokes,_global.PART.SMOKE2,createSmoke(2)),_defineProperty(_smokes,_global.PART.SMOKE3,createSmoke(3)),_smokes);this.explode=new Array(16);var COUNT_GENERATED_EXPLODE=2;var _loop4=function _loop4(_i17){var explode=createSpark(false);_this.explode[_i17]=[];explode.forEach(function(exp){_this.explode[_i17].push(exp.getColor2([255,0,0],[255,255,127],exp))})};for(var _i17=0;_i17<COUNT_GENERATED_EXPLODE;_i17++){_loop4(_i17)}var _loop5=function _loop5(_i18){_this.explode[_i18]=[];var angle=Math.random()*4;var ind=Math.random()*COUNT_GENERATED_EXPLODE|0;_this.explode[ind].forEach(function(exp){return _this.explode[_i18].push(rotateImage(exp,angle))})};for(var _i18=COUNT_GENERATED_EXPLODE;_i18<this.explode.length;_i18++){_loop5(_i18)}this.indicator=new _buffer2.default(tileSize).forEach(function(a,i){return i/tileSize}).getColor2([255,0,0],[0,255,0]);var itemText=(_itemText={},_defineProperty(_itemText,_global.ITEM.LIFE,"Life"),_defineProperty(_itemText,_global.ITEM.KNUKLE,"Knukle"),_defineProperty(_itemText,_global.ITEM.ZOMBIE,"Friendly#fire"),_defineProperty(_itemText,_global.ITEM.STAR,"Star"),_defineProperty(_itemText,_global.ITEM.SPEED,"Speed"),_defineProperty(_itemText,_global.ITEM.FIREBALL,"Fireball"),_defineProperty(_itemText,_global.ITEM.FIREBALL+1,"Private"),_defineProperty(_itemText,_global.ITEM.FIREBALL+2,"Corporal"),_defineProperty(_itemText,_global.ITEM.FIREBALL+3,"Junior#sergeant"),_defineProperty(_itemText,_global.ITEM.FIREBALL+4,"Sergeant"),_defineProperty(_itemText,_global.ITEM.FIREBALL+5,"Senior#sergeant"),_defineProperty(_itemText,_global.ITEM.FIREBALL+6,"Sergeant#major"),_defineProperty(_itemText,_global.ITEM.FIREBALL+7,"Junior#lieutenant"),_defineProperty(_itemText,_global.ITEM.FIREBALL+8,"Lieutenant"),_defineProperty(_itemText,_global.ITEM.FIREBALL+9,"Captain"),_defineProperty(_itemText,_global.ITEM.FIREBALL+10,"Major"),_defineProperty(_itemText,_global.ITEM.FIREBALL+11,"Colonel"),_defineProperty(_itemText,_global.ITEM.FIREBALL+12,"Major#general"),_defineProperty(_itemText,_global.ITEM.FIREBALL+13,"Lieutenant#general"),_defineProperty(_itemText,_global.ITEM.FIREBALL+14,"Colonel#general"),_defineProperty(_itemText,_global.ITEM.FIREBALL+15,"Army#general"),_defineProperty(_itemText,_global.ITEM.FIREBALL+16,"Marshal"),_itemText);this.itemText={};for(var _i19=_global.ITEM.LIFE;_i19<=_global.ITEM.FIREBALL+16;_i19++){var mask=new _buffer2.default(tileSize*3);var buf=mask.getColor([0,0,0],mask);var ctx=buf.getContext("2d");ctx.font=(tileSize*.5|0)+"px Verdana, Geneva, Arial, Helvetica, sans-serif";ctx.fillStyle=_i19<=_global.ITEM.FIREBALL?"rgb(200, 255, 200)":"rgb(255, 200, 200)";ctx.textAlign="center";var texts=itemText[_i19].split("#");var y=texts.length>1?1.5:2;ctx.fillText(texts[0],tileSize*1.5,tileSize*y);if(texts.length===2)ctx.fillText(texts[1],tileSize*1.5,tileSize*2);this.itemText[_i19]=buf}};exports.default=GenTextures},{"../global":7,"../utils":15,"./buffer":5}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.LEVEL_TIME=exports.PART=exports.ITEM=exports.BULLET=exports.STATE=exports.TANK=undefined;exports.tankRadius=tankRadius;exports.tankLife=tankLife;exports.botTypeProbability=botTypeProbability;exports.angleProbability=angleProbability;exports.shootTime=shootTime;exports.tankVelocity=tankVelocity;exports.directionTime=directionTime;exports.tankWeaponType=tankWeaponType;exports.bulletVelocity=bulletVelocity;exports.bulletDamage=bulletDamage;exports.bulletsCount=bulletsCount;exports.getItem=getItem;exports.itemRespawnTime=itemRespawnTime;exports.timeToRespawn=timeToRespawn;exports.getScores=getScores;exports.scoreToLevelup=scoreToLevelup;var _utils=require("./utils");var TANK=exports.TANK={TANK1:0,TANK2:1,SIMPLE:2,BMP:3,CANNON:4,STRONG:5,PANZER:6,RANDOM:7,EAGLE:8};var STATE=exports.STATE={DEAD:0,RESPAWN:1,GOD:2,NORMAL:3};function tankRadius(type){return type<TANK.PANZER?.8:1}function tankLife(type){console.assert(type>=TANK.TANK1&&type<=TANK.EAGLE,"Wrong tank type");var lifeTable=[1,1,1,1,1,4,6,0,1];return lifeTable[type]}function botTypeProbability(difficulty){var botTypeProbabilities=[[0,0,10,6,6,3,1],[0,0,5,5,5,3,2],[0,0,2,4,4,4,3],[0,0,1,3,3,4,4]];var ind=difficulty/4|0;console.assert(ind>=0&&ind<4,"Wrong difficulty value");return(0,_utils.getProbability)(botTypeProbabilities[ind])}function angleProbability(){return(0,_utils.getProbability)([1,3,5,3])}function shootTime(difficulty){var shootTable=[2e3,1700,1300,1e3,800,750,700,650,600,500,450,400,350,300,250,200];console.assert(difficulty>=0&&difficulty<16,"Wrong difficulty value");return shootTable[difficulty]}function tankVelocity(type){console.assert(type>=TANK.TANK1&&type<=TANK.EAGLE,"Wrong tank type");return[1.5,1.5,1.2,2.4,1.2,1,.75,0,0][type]}function directionTime(collision){return collision?(0,_utils.rand)(250,150):(0,_utils.rand)(3e3,1e3)}var BULLET=exports.BULLET={SIMPLE:0,SINGLE:1,DOUBLE:2,POWER:3,FIRE:4};function tankWeaponType(type){var weaTable=[BULLET.SIMPLE,BULLET.SIMPLE,BULLET.SIMPLE,BULLET.SIMPLE,BULLET.SINGLE,BULLET.SIMPLE,BULLET.POWER|BULLET.FIRE,BULLET.SIMPLE,BULLET.SIMPLE];console.assert(type>=TANK.TANK1&&type<=TANK.EAGLE,"Wrong tank type");return weaTable[type]}function bulletVelocity(type){return type&(BULLET.SINGLE|BULLET.DOUBLE)?7.2:2.88}function bulletDamage(type){return(type&BULLET.POWER)===BULLET.POWER?2:1}function bulletsCount(type){return type&BULLET.DOUBLE?2:1}var ITEM=exports.ITEM={LIFE:0,KNUKLE:1,ZOMBIE:2,STAR:3,SPEED:4,FIREBALL:5};function getItem(){var probs=[1,2,2,2,2,2];var ind=(0,_utils.getProbability)(probs);return ind}function itemRespawnTime(difficulty){var timeTable=[15e3,13e3,12e3,11e3,1e4,8e3,7e3,6e3,5e3,3e3,2e3,1e3,1,1,1,1];console.assert(difficulty>=0&&difficulty<16,"Wrong difficulty value");return _utils.Random.next(timeTable[difficulty])+1e4}var SMOKE0=32;var SMOKE1=64;var SMOKE2=128;var SMOKE3=256;var PART=exports.PART={SPARK:1,FIRE:2,BRICK:4,BETON:8,EXPLODE:16,SMOKE0:SMOKE0,SMOKE1:SMOKE1,SMOKE2:SMOKE2,SMOKE3:SMOKE3,SMOKE:SMOKE0|SMOKE1|SMOKE2|SMOKE3};function timeToRespawn(difficulty){var respTable=[1e3,950,900,850,800,750,700,650,600,575,550,525,500,400,300,200];console.assert(difficulty>=0&&difficulty<16,"Wrong difficulty value");return respTable[difficulty]+_utils.Random.next(3e3-difficulty*133)}function getScores(type){console.assert(type>=TANK.TANK1&&type<=TANK.EAGLE,"Wrong tank type");return[0,0,1,3,2,5,8,0,0][type]}function scoreToLevelup(difficulty){console.assert(difficulty>=0&&difficulty<16,"Wrong difficulty value");return 25*(difficulty+1)}var LEVEL_TIME=exports.LEVEL_TIME=6e4},{"./utils":15}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _utils=require("./utils");var _entity=require("./entity");var _global=require("./global");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Item=function(_Entity){_inherits(Item,_Entity);function Item(event){_classCallCheck(this,Item);var _getMapSize=(0,_utils.getMapSize)(),mapWidth=_getMapSize.mapWidth,mapHeight=_getMapSize.mapHeight;var cx=_utils.Random.next(mapWidth-4)+1|0;var cy=_utils.Random.next(mapHeight-4)+1|0;var _this=_possibleConstructorReturn(this,(Item.__proto__||Object.getPrototypeOf(Item)).call(this,cx,cy));_this.type=(0,_global.getItem)();_this.event=event;return _this}_createClass(Item,[{key:"draw",value:function draw(level){level.drawEntityBegin(this,level.textures.item[this.type])}},{key:"update",value:function update(tanks){var _this2=this;tanks.objects.forEach(function(tank){if(tank.state<=_global.STATE.RESPAWN||tank.type===_global.TANK.EAGLE||!_this2.alive)return;if(_this2.collide(tank,(0,_global.tankRadius)(tank.type),.8)){_this2.alive=false;_this2.event.emit("item",_this2.type,tank)}})}}]);return Item}(_entity.Entity);var ItemManager=function(_EntityManager){_inherits(ItemManager,_EntityManager);function ItemManager(difficulty,event,mode){_classCallCheck(this,ItemManager);var _this3=_possibleConstructorReturn(this,(ItemManager.__proto__||Object.getPrototypeOf(ItemManager)).call(this));_this3.event=event;_this3.mode=mode;_this3.difficulty=difficulty;_this3.end_of_time=false;event.on("levelup",function(diff){_this3.difficulty=diff});event.on("endOfTime",function(){_this3.end_of_time=_this3.mode!=="bench"});return _this3}_createClass(ItemManager,[{key:"reset",value:function reset(){this.respawnTime=(0,_global.itemRespawnTime)(this.difficulty);this.end_of_time=false}},{key:"update",value:function update(tanks,time){if(time>this.respawnTime&&!this.end_of_time){this.objects.push(new Item(this.event));this.respawnTime=time+(0,_global.itemRespawnTime)(this.difficulty)}this.objects.forEach(function(item){return item.update(tanks)});this.splice()}},{key:"addItem",value:function addItem(type,cx,cy){var item=new Item(this.event);item.type=type;item.cx=cx;item.cy=cy;this.objects.push(item)}}]);return ItemManager}(_entity.EntityManager);exports.default=ItemManager},{"./entity":2,"./global":7,"./utils":15}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Level=exports.Layer=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _utils=require("./utils");var _genTextures=require("./gener/genTextures");var _genTextures2=_interopRequireDefault(_genTextures);var _global=require("./global");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var EMPTY=1;var HALF=2;var BRICK=4;var BETON=8;var WATER=16;var GRASS=32;var PREGRASS=64;var BRIDGEH=128;var BRIDGEV=256;var BRIDGE=BRIDGEH|BRIDGEV;var MOVE_MASK=HALF|BRICK|BETON|WATER;var BULLET_MASK=HALF|BRICK|BETON;var Layer=exports.Layer=function Layer(width,height){_classCallCheck(this,Layer);this.canvas=document.createElement("canvas");this.canvas.width=width;this.canvas.height=height;this.context=this.canvas.getContext("2d")};var Level=exports.Level=function(){function Level(levelName,canvas,event){var _this=this;_classCallCheck(this,Level);var _getMapSize=(0,_utils.getMapSize)(),mapWidth=_getMapSize.mapWidth,mapHeight=_getMapSize.mapHeight;var tileSize=(0,_utils.getTileSize)(canvas.width,canvas.height);console.log("tileSize = "+tileSize);this.canvas=canvas;this.event=event;this.tileSize=tileSize;this.mapWidth=mapWidth-2;this.mapHeight=mapHeight-2;this.textures=new _genTextures2.default(tileSize);this.layer=new Layer(mapWidth*tileSize,mapHeight*tileSize);this.layer0=new Layer(mapWidth*tileSize,mapHeight*tileSize);this.layer1=new Layer(mapWidth*tileSize,mapHeight*tileSize);this.layerGrass=new Layer(mapWidth*tileSize,mapHeight*tileSize);var layerGround=new Layer(mapWidth*tileSize,mapHeight*tileSize);var layerBrick=new Layer(mapWidth*tileSize,mapHeight*tileSize);var layerHalf=new Layer(mapWidth*tileSize,mapHeight*tileSize);var layerLava=new Layer(mapWidth*tileSize,mapHeight*tileSize);var renderBoard=function renderBoard(){for(var i=0;i<mapWidth;i++){layerGround.context.drawImage(_this.textures.board,i*tileSize,0);layerGround.context.drawImage(_this.textures.board,i*tileSize,(mapHeight-1)*tileSize)}for(var _i=1;_i<mapHeight-1;_i++){layerGround.context.drawImage(_this.textures.board,0,_i*tileSize);layerGround.context.drawImage(_this.textures.board,(mapWidth-1)*tileSize,_i*tileSize)}};var renderTexture=function renderTexture(destLayer,texture){for(var y=0;y<destLayer.canvas.height;y+=texture.height){for(var x=0;x<destLayer.canvas.width;x+=texture.width){destLayer.context.drawImage(texture,x,y)}}};var calcTilePos=function calcTilePos(index,minusHalf){var x=1+index%(mapWidth-2)|0;var y=1+index/(mapWidth-2)|0;var posX=x*tileSize;var posY=y*tileSize;if(minusHalf){posX-=tileSize/2|0;posY-=tileSize/2|0}return{posX:posX,posY:posY}};var renderLava=function renderLava(){var oldGround=layerGround.context.globalCompositeOperation;layerGround.context.globalCompositeOperation="multiply";_this.map.forEach(function(tile,index){if(tile.type&(WATER|BRIDGE)){var _calcTilePos=calcTilePos(index,true),posX=_calcTilePos.posX,posY=_calcTilePos.posY;var ind=Math.random()*_this.textures.lavaMask.length|0;layerLava.context.drawImage(_this.textures.lavaMask[ind],posX,posY);layerGround.context.drawImage(_this.textures.lavaLightMask[ind],posX,posY)}});var oldLava=layerLava.context.globalCompositeOperation;layerLava.context.globalCompositeOperation="source-atop";renderTexture(layerLava,_this.textures.lava);layerGround.context.globalCompositeOperation=oldGround;layerLava.context.globalCompositeOperation=oldLava};var renderBridge=function renderBridge(){_this.map.forEach(function(tile,index){if(tile.type&BRIDGE){var _calcTilePos2=calcTilePos(index,true),posX=_calcTilePos2.posX,posY=_calcTilePos2.posY;var ind=Math.random()*_this.textures.bridgeV.length|0;if(tile.type&BRIDGEV){layerLava.context.drawImage(_this.textures.bridgeV[ind],posX,posY)}else{layerLava.context.drawImage(_this.textures.bridgeH[ind],posX,posY)}}})};var renderBrick=function renderBrick(){_this.map.forEach(function(tile,index){if(tile.type&(BRICK|BETON)){var _calcTilePos3=calcTilePos(index,false),posX=_calcTilePos3.posX,posY=_calcTilePos3.posY;var img=tile.type&BRICK?_this.textures.brick:_this.textures.beton;var imgHalf=tile.type&BRICK?_this.textures.halfBrick:_this.textures.halfBeton;var srcX=posX%img.width|0;var srcY=posY%img.height|0;layerBrick.context.drawImage(img,srcX,srcY,tileSize,tileSize,posX,posY,tileSize,tileSize);layerHalf.context.drawImage(imgHalf,srcX,srcY,tileSize,tileSize,posX,posY,tileSize,tileSize)}})};var renderGrass=function renderGrass(){_this.map.forEach(function(tile,index){if(tile.type&GRASS){var _calcTilePos4=calcTilePos(index,true),posX=_calcTilePos4.posX,posY=_calcTilePos4.posY;var ind=Math.random()*_this.textures.lavaMask.length|0;_this.layerGrass.context.drawImage(_this.textures.grassMask[ind],posX,posY)}});var oldGrass=_this.layerGrass.context.globalCompositeOperation;_this.layerGrass.context.globalCompositeOperation="source-atop";renderTexture(_this.layerGrass,_this.textures.grass);_this.layerGrass.context.globalCompositeOperation=oldGrass};var loadLevelFromArray=function loadLevelFromArray(data){_this.map=data.map(function(val){switch(val){case 0:return{x:0,y:0,type:EMPTY};case 1:return{x:0,y:0,type:BRICK};case 2:return{x:0,y:0,type:BETON};case 3:return{x:0,y:0,type:WATER};case 4:return{x:0,y:0,type:GRASS};case 5:return{x:0,y:0,type:BRIDGEH};case 6:return{x:0,y:0,type:BRIDGEV};default:return console.assert(false,"Unknown tile type "+val)}});for(var j=0;j<_this.mapHeight;j++){for(var i=0;i<_this.mapWidth;i++){_this.map[j*_this.mapWidth+i].x=i+1;_this.map[j*_this.mapWidth+i].y=j+1;for(var dy=-1;dy<2;dy++){for(var dx=-1;dx<2;dx++){var x=i+dx|0;var y=j+dy|0;if(x>=0&&x<_this.mapWidth&&y>=0&&y<_this.mapHeight&&_this.map[y*_this.mapWidth+x].type&GRASS){_this.map[j*_this.mapWidth+i].type|=PREGRASS}}}}}};var loadLevel=function loadLevel(callback){console.log("Loading "+levelName+".tmx level");var reader=new XMLHttpRequest;reader.open("get",levelName+".tmx",true);reader.onload=function(){var parser=new DOMParser;var xml=parser.parseFromString(reader.responseText,"text/xml");console.assert(xml.childNodes.length===1,"Count children must bu 1");var attrs=xml.childNodes[0].attributes;console.assert(attrs.width.textContent===""+_this.mapWidth);console.assert(attrs.height.textContent===""+_this.mapHeight);console.assert(xml.childNodes[0].childNodes.length===5,"Should be tileset and layer");console.assert(xml.childNodes[0].childNodes[3].childNodes.length===3,"Should be data");var data=xml.childNodes[0].childNodes[3].childNodes[1].textContent.split(/\s|,/).filter(function(val){return val!==""}).map(function(val){return parseInt(val,10)});console.assert(data.length===_this.mapWidth*_this.mapHeight,"Wrong count tiles");loadLevelFromArray(data);callback()};reader.onerror=function(){return console.assert(false,"Couldn't load "+levelName+".tmx")};reader.send()};loadLevel(function(){var renderTime=Date.now();renderTexture(layerGround,_this.textures.ground);renderLava();renderBridge();renderBoard();renderBrick();renderGrass();_this.layer.context.drawImage(layerGround.canvas,0,0);_this.layer.context.drawImage(layerLava.canvas,0,0);_this.layer.context.drawImage(layerBrick.canvas,0,0);_this.layer.context.drawImage(_this.layerGrass.canvas,0,0);_this.layer0.context.drawImage(layerGround.canvas,0,0);_this.layer0.context.drawImage(layerLava.canvas,0,0);_this.layer0.context.drawImage(_this.layerGrass.canvas,0,0);_this.layer1.context.drawImage(layerGround.canvas,0,0);_this.layer1.context.drawImage(layerLava.canvas,0,0);_this.layer1.context.drawImage(layerHalf.canvas,0,0);_this.layer1.context.drawImage(_this.layerGrass.canvas,0,0);_this.context=canvas.getContext("2d");_this.context.drawImage(_this.layer.canvas,0,0);console.log("Render time = "+(Date.now()-renderTime));_this.event.emit("levelCreated")})}_createClass(Level,[{key:"ready",value:function ready(){return!!this.context}},{key:"drawInterface",value:function drawInterface(life,fireball,speed,star,time,diff,scores,bestScores){var x=this.mapWidth/2-5;this.context.fillStyle="black";this.context.fillRect((x-8)*this.tileSize,(this.mapHeight+2)*this.tileSize,this.canvas.width-2*this.tileSize,this.tileSize*2);this.drawTile(this.textures.itemText[diff],0,0,x-3,this.mapHeight+.85,3);if(fireball)this.drawTile(this.textures.fireSmall[0],0,0,x,this.mapHeight+2.1,1);if(speed)this.drawTile(this.textures.speedImg,0,0,x+.5,this.mapHeight+1.5,2);if(star)this.drawTile(this.textures.starImg,0,0,x+1.75,this.mapHeight+1.5,2);this.drawTile(this.textures.lifeImg,0,0,x+4.1,this.mapHeight+1.5,2);this.context.font=(this.tileSize*.75|0)+"px Verdana, Geneva, Arial, Helvetica, sans-serif";this.context.fillStyle="white";this.context.fillText("x "+life,(x+6)*this.tileSize,(this.mapHeight+3)*this.tileSize-this.tileSize*.25);this.context.font=(this.tileSize*.5|0)+"px Verdana, Geneva, Arial, Helvetica, sans-serif";var bestStr=bestScores&&bestScores!==scores?" ("+bestScores+")":"";this.context.fillText("Scores: "+scores+bestStr,(x-8)*this.tileSize,(this.mapHeight+3.1)*this.tileSize-this.tileSize*.25);if(time>0){this.context.drawImage(this.textures.indicator,0*this.tileSize,0*this.tileSize,time*this.tileSize,1*this.tileSize,(x+10)*this.tileSize,(this.mapHeight+2)*this.tileSize,time*13*this.tileSize,1*this.tileSize)}}},{key:"drawTile",value:function drawTile(texture,srcx,srcy,dstx,dsty,size){var destContext=arguments.length>6&&arguments[6]!==undefined?arguments[6]:this.context;destContext.drawImage(texture,srcx*this.tileSize,srcy*this.tileSize,size*this.tileSize,size*this.tileSize,dstx*this.tileSize,dsty*this.tileSize,size*this.tileSize,size*this.tileSize)}},{key:"clearEntity",value:function clearEntity(entity){var x=entity.cx+1-entity.size*.5;var y=entity.cy+1-entity.size*.5;this.drawTile(this.layer.canvas,x,y,x,y,entity.size)}},{key:"drawEntityBegin",value:function drawEntityBegin(entity,texture){var destContext=arguments.length>2&&arguments[2]!==undefined?arguments[2]:this.context;var x=entity.cx+1-entity.size*.5;var y=entity.cy+1-entity.size*.5;this.drawTile(texture,0,0,x,y,entity.size,destContext)}},{key:"drawEntityEnd",value:function drawEntityEnd(entity){var destContext=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.context;if(this.collidePoint(entity.cx,entity.cy,PREGRASS|GRASS)){var x=entity.cx+1-entity.size*.5;var y=entity.cy+1-entity.size*.5;this.drawTile(this.layerGrass.canvas,x,y,x,y,entity.size,destContext)}}},{key:"drawEntity",value:function drawEntity(entity,texture){this.drawEntityBegin(entity,texture);this.drawEntityEnd(entity)}},{key:"drawEntityToAllLayers",value:function drawEntityToAllLayers(entity,texture){this.drawEntityBegin(entity,texture,this.layer.context);this.drawEntityEnd(entity,this.layer.context);this.drawEntityBegin(entity,texture,this.layer0.context);this.drawEntityEnd(entity,this.layer0.context);this.clearEntity(entity)}},{key:"getTile",value:function getTile(x,y){if(x<0||x>=this.mapWidth||y<0||y>=this.mapHeight)return null;var ix=x|0;var iy=y|0;var ind=iy*this.mapWidth+ix;return this.map[ind]}},{key:"collidePoint",value:function collidePoint(x,y,mask){var tile=this.getTile(x,y);return!tile||!!(tile.type&mask)}},{key:"collideTank",value:function collideTank(entity){var x=entity.cx+(0,_utils.cos)(entity.angle)*.5*entity.size;var y=entity.cy+(0,_utils.sin)(entity.angle)*.5*entity.size;var x1=x+(0,_utils.cos)(entity.angle+1&3)*.5;var y1=y+(0,_utils.sin)(entity.angle+1&3)*.5;var x2=x-(0,_utils.cos)(entity.angle+1&3)*.5;var y2=y-(0,_utils.sin)(entity.angle+1&3)*.5;return this.collidePoint(x1,y1,MOVE_MASK)||this.collidePoint(x2,y2,MOVE_MASK)}},{key:"collideTankEx",value:function collideTankEx(entity){var x=entity.cx;var y=entity.cy;return this.collidePoint(x+.5,y+.5,MOVE_MASK)||this.collidePoint(x+.5,y-.5,MOVE_MASK)||this.collidePoint(x-.5,y-.5,MOVE_MASK)||this.collidePoint(x-.5,y+.5,MOVE_MASK)}},{key:"collideBullet",value:function collideBullet(entity,power){var _this2=this;var x1=entity.cx+(0,_utils.cos)(entity.angle+1&3)*.5;var y1=entity.cy+(0,_utils.sin)(entity.angle+1&3)*.5;var x2=entity.cx-(0,_utils.cos)(entity.angle+1&3)*.5;var y2=entity.cy-(0,_utils.sin)(entity.angle+1&3)*.5;var collide1=this.collidePoint(x1,y1,BULLET_MASK);var collide2=this.collidePoint(x2,y2,BULLET_MASK);var decrementLevel=function decrementLevel(x,y){var tile=_this2.getTile(x,y);if(tile){var tileType=tile.type&BULLET_MASK;var needHalf=tileType===BRICK&&!power||tileType===BETON&&power;var needEmpty=tileType===(BRICK|HALF)||tileType===(BETON|HALF)&&power||tileType===BRICK&&power;var partType=tileType&BRICK?_global.PART.BRICK:_global.PART.BETON;if(needHalf){tile.type|=HALF;_this2.drawTile(_this2.layer1.canvas,tile.x,tile.y,tile.x,tile.y,1,_this2.layer.context);_this2.drawTile(_this2.layer.canvas,tile.x,tile.y,tile.x,tile.y,1);_this2.event.emit("particle",tile.x-.5,tile.y-.5,partType)}else if(needEmpty){tile.type&=~BULLET_MASK;_this2.drawTile(_this2.layer0.canvas,tile.x,tile.y,tile.x,tile.y,1,_this2.layer.context);_this2.drawTile(_this2.layer.canvas,tile.x,tile.y,tile.x,tile.y,1);_this2.event.emit("particle",tile.x-.5,tile.y-.5,partType);if(tileType===BRICK){_this2.event.emit("particle",tile.x-.5,tile.y-.5,partType)}}}};if(collide1)decrementLevel(x1,y1);if(collide2)decrementLevel(x2,y2);return collide1||collide2}}]);return Level}()},{"./gener/genTextures":6,"./global":7,"./utils":15}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var LocalStorage=function(){function LocalStorage(){_classCallCheck(this,LocalStorage)}_createClass(LocalStorage,null,[{key:"localStorageSupported",value:function localStorageSupported(){try{var testKey="test";var storage=window.localStorage;storage.setItem(testKey,"1");storage.removeItem(testKey);return true}catch(error){return false}}},{key:"getBestScore",value:function getBestScore(id){var supported=LocalStorage.localStorageSupported();if(!supported)return 0;return window.localStorage.getItem("tpp "+id)||0}},{key:"setBestScore",value:function setBestScore(id,score){var supported=LocalStorage.localStorageSupported();if(!supported)return 0;var current=parseInt(this.getBestScore(id),10);if(!current||score>current){window.localStorage.setItem("tpp "+id,score);return score}return current}},{key:"saveReplay",value:function saveReplay(id,replay){if(!LocalStorage.localStorageSupported())return;window.localStorage.setItem("tpp/replay "+id,replay)}},{key:"loadReplay",value:function loadReplay(id){if(!LocalStorage.localStorageSupported())return"";return window.localStorage.getItem("tpp/replay "+id)||""}}]);return LocalStorage}();exports.default=LocalStorage},{}],11:[function(require,module,exports){"use strict";var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}();var _utils=require("./utils");var _game=require("./game");var _game2=_interopRequireDefault(_game);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function calcSizeForCanvas(width,height){var _getMapSize=(0,_utils.getMapSize)(),mapWidth=_getMapSize.mapWidth,mapHeight=_getMapSize.mapHeight;var aspect=width/height;var mapAspect=mapWidth/(mapHeight+1);if(mapAspect>aspect){return{width:width,height:width/mapAspect}}return{width:height*mapAspect,height:height}}function getRequestAnimationFrame(){if(window.requestAnimationFrame)return window.requestAnimationFrame;var vendors=["webkit","moz","ms","o"];for(var i=0;i<vendors.length;i++){if(window[vendors[i]+"RequestAnimationFrame"]){return window[vendors[i]+"RequestAnimationFrame"]}}var lastTime=0;return function(callback){var currTime=Date.now();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=setTimeout(function(){return callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id}}function parseURL(){var retParams={mode:"level",difficulty:"0",twoplayers:"false",base64:""};var url=window.location.search.substr(1);var params=url.split("&");params.forEach(function(param){var _param$split=param.split("="),_param$split2=_slicedToArray(_param$split,2),key=_param$split2[0],value=_param$split2[1];if(key in retParams&&value!==undefined){retParams[key]=value}});return retParams}function main(){console.assert=function(condition){var message=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"Assertion failed";if(!condition){console.log(message);if(typeof Error!=="undefined"){throw new Error(message)}throw message}};var canvas=document.getElementById("canvas");var _calcSizeForCanvas=calcSizeForCanvas(document.documentElement.clientWidth-40,document.documentElement.clientHeight-40),width=_calcSizeForCanvas.width,height=_calcSizeForCanvas.height;canvas.width=width;canvas.height=height;var game=new _game2.default(canvas,parseURL());var lastTime=0;var frameCount=0;var calcFPS=function calcFPS(){var now=Date.now();frameCount++;if(now>lastTime){var tileSize=(0,_utils.getTileSize)(canvas.width,canvas.height);var context=canvas.getContext("2d");context.fillStyle="black";context.fillRect(0,canvas.height-tileSize,5*tileSize,tileSize);context.font=(tileSize*.35|0)+"px Verdana, Geneva, Arial, Helvetica, sans-serif";context.fillStyle="white";context.fillText("FPS = "+frameCount+" | Press 'P' to pause",0,canvas.height-tileSize*.5);lastTime=now+1e3;frameCount=0}};var getGamepads=function getGamepads(){if(navigator.getGamepads)return navigator.getGamepads();if("webkitGetGamepads"in navigator){return navigator.webkitGetGamepads()}if("mozGetGamepads"in navigator){return navigator.mozGetGamepads()}if("webkitGamepads"in navigator){return navigator.webkitGamepads}if("mozGamepads"in navigator){return navigator.mozGamepads}return[]};var animationFrame=getRequestAnimationFrame();var update=function update(){var gamepads=getGamepads();for(var i=0;i<gamepads.length;i++){var gp=gamepads[i];if(gp){game.gpAxes(gp.axes[0],gp.axes[1]);game.gpButton(gp.buttons[1].pressed)}}game.update();calcFPS();animationFrame(update)};animationFrame(update);document.onkeydown=function(event){game.onkeydown(event.keyCode);event.preventDefault()};document.onkeyup=function(event){game.onkeyup(event.keyCode);event.preventDefault()};document.onvisibilitychange=function(){if(document.visibilityState==="hidden"){game.forcepause()}}}window.addEventListener("load",main)},{"./game":4,"./utils":15}],12:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _entity=require("./entity");var _global=require("./global");var _utils=require("./utils");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Particle=function(_Entity){_inherits(Particle,_Entity);function Particle(cx,cy,type){_classCallCheck(this,Particle);var _this=_possibleConstructorReturn(this,(Particle.__proto__||Object.getPrototypeOf(Particle)).call(this,cx,cy,.5,Math.random()*2*Math.PI,(0,_utils.mathRand)(1,.5)));_this.type=type;_this.creationTime=0;_this.random=Math.random();_this.lifetime=250;_this.deltatime=0;if(type===_global.PART.FIRE)_this.size=2;else if(type===_global.PART.EXPLODE){_this.size=4;_this.lifetime=480;_this.decal=new _entity.Entity(cx,cy,3)}else if(type&(_global.PART.BRICK|_global.PART.BETON)){_this.cx+=Math.cos(_this.angle)*.5*Math.random();_this.cy+=Math.sin(_this.angle)*.5*Math.random();_this.lifetime+=(0,_utils.mathRand)(100,100);_this.maxvel=_this.vel;_this.startAngle=Math.random();_this.omega=(0,_utils.mathRand)(0,1/30)}else if(type&_global.PART.SMOKE){_this.size=1;_this.lifetime=(0,_utils.mathRand)(750,250);_this.angle=(0,_utils.mathRand)(-1,.2);_this.vel=(0,_utils.mathRand)(.5,.2);_this.cx=(0,_utils.mathRand)(cx,.1);_this.cy=(0,_utils.mathRand)(cy,.1)}return _this}_createClass(Particle,[{key:"getBrickTexture",value:function getBrickTexture(level){var textures=this.type===_global.PART.BRICK?level.textures.sparksBrick:level.textures.sparksBeton;var id=(0,_utils.floatToIndex)(this.random,textures.length);var ind=(this.deltatime*this.omega+textures[id].length*this.startAngle|0)%textures[id].length|0;if(ind<0)ind+=textures[id].length;return textures[id][ind]}},{key:"draw",value:function draw(level){if(this.alive){switch(this.type){case _global.PART.SPARK:{var ind=(0,_utils.floatToIndex)(this.deltatime/this.lifetime,level.textures.sparksBullet.length);level.drawEntity(this,level.textures.sparksBullet[ind]);break}case _global.PART.FIRE:{var id=(0,_utils.floatToIndex)(this.random,level.textures.sparksFire.length);var _ind=(0,_utils.floatToIndex)(this.deltatime/this.lifetime,level.textures.sparksFire[id].length);level.drawEntity(this,level.textures.sparksFire[id][_ind]);break}case _global.PART.BRICK:case _global.PART.BETON:{this.vel=this.maxvel*(1-this.deltatime/this.lifetime);level.drawEntity(this,this.getBrickTexture(level));break}case _global.PART.EXPLODE:{var _id=(0,_utils.floatToIndex)(this.random,level.textures.explode.length);var _ind2=(0,_utils.floatToIndex)(this.deltatime/this.lifetime,level.textures.explode[_id].length);level.drawEntity(this,level.textures.explode[_id][_ind2]);if(this.decal){var index=(0,_utils.floatToIndex)(Math.random(),level.textures.decals.length);level.drawEntityToAllLayers(this.decal,level.textures.decals[index]);this.decal=null}break}case _global.PART.SMOKE0:case _global.PART.SMOKE1:case _global.PART.SMOKE2:case _global.PART.SMOKE3:{var _ind3=(0,_utils.floatToIndex)(this.deltatime/this.lifetime,level.textures.smokes[this.type].length);level.drawEntity(this,level.textures.smokes[this.type][_ind3]);break}default:break}}}},{key:"update",value:function update(level){var time=Date.now();if(!this.creationTime)this.creationTime=time;this.deltatime=time-this.creationTime;if(this.deltatime>=this.lifetime){this.alive=false;if(this.type&(_global.PART.BRICK|_global.PART.BETON)){level.drawEntityToAllLayers(this,this.getBrickTexture(level))}}if(this.type&(_global.PART.SPARK|_global.PART.BRICK|_global.PART.BETON|_global.PART.SMOKE)){var delta=this.getDelta(time);this.moveEx(delta)}}}]);return Particle}(_entity.Entity);var ParticleManager=function(_EntityManager){_inherits(ParticleManager,_EntityManager);function ParticleManager(event){_classCallCheck(this,ParticleManager);var _this2=_possibleConstructorReturn(this,(ParticleManager.__proto__||Object.getPrototypeOf(ParticleManager)).call(this));var emit=function emit(cx,cy,type){var count=1;if(type===_global.PART.SPARK)count=5;else if(type&(_global.PART.BRICK|_global.PART.BETON))count=10;for(var i=0;i<count;i++){_this2.objects.push(new Particle(cx,cy,type))}};event.on("particle",emit);event.on("tankDead",function(tank){var r=tank.size*.4;for(var i=0;i<16;i++){emit((0,_utils.mathRand)(tank.cx,r),(0,_utils.mathRand)(tank.cy,r),_global.PART.SMOKE2)}emit(tank.cx,tank.cy,_global.PART.EXPLODE)});return _this2}_createClass(ParticleManager,[{key:"draw",value:function draw(level,layer){var layer0=_global.PART.BRICK|_global.PART.BETON;var layer1=_global.PART.SPARK|_global.PART.FIRE|_global.PART.EXPLODE|_global.PART.SMOKE;this.objects.forEach(function(part){if(part.type&layer0&&layer===0)part.draw(level);else if(part.type&layer1&&layer===1)part.draw(level)})}}]);return ParticleManager}(_entity.EntityManager);exports.default=ParticleManager},{"./entity":2,"./global":7,"./utils":15}],13:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _utils=require("./utils");var _global=require("./global");var _local_storage=require("./local_storage");var _local_storage2=_interopRequireDefault(_local_storage);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var RawBuffer=function(){function RawBuffer(){_classCallCheck(this,RawBuffer);this.currentOffset=0;this.currentByte=0;this.data=[];this.base64="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890*-"}_createClass(RawBuffer,[{key:"saveByte",value:function saveByte(){console.assert(this.currentByte>=0&&this.currentByte<256);this.data.push(this.currentByte);this.currentByte=0}},{key:"reset",value:function reset(){this.currentOffset=0}},{key:"done",value:function done(){if(this.currentOffset&7)this.saveByte();var tail=this.data.length%3|0;if(tail>0)this.addBits(8,0);if(tail===1)this.addBits(8,0);this.reset()}},{key:"addUint16",value:function addUint16(val){this.addBits(2*8,val)}},{key:"addUint32",value:function addUint32(val){this.addBits(4*8,val)}},{key:"addBool",value:function addBool(val){this.addBits(1,val?1:0)}},{key:"getUint16",value:function getUint16(){return this.getBits(2*8)}},{key:"getUint32",value:function getUint32(){return this.getBits(4*8)}},{key:"getBool",value:function getBool(){return!!this.getBits(1)}},{key:"addBits",value:function addBits(bits,val){console.assert(bits===32||val<1<<bits);var offsetInCurrentByte=this.currentOffset&7;var padding=8-offsetInCurrentByte;this.currentByte|=(val&255)<<offsetInCurrentByte&255;if(padding<=bits)this.saveByte();if(padding<bits){this.currentOffset+=padding;this.addBits(bits-padding,val>>padding);return}this.currentOffset+=bits}},{key:"getBits",value:function getBits(bits){var offsetInCurrentByte=this.currentOffset&7;var padding=8-offsetInCurrentByte;var currentIndex=this.currentOffset>>3;if(currentIndex>=this.data.length)return 0;var val=this.data[currentIndex]>>offsetInCurrentByte;if(padding>=bits){this.currentOffset+=bits;return val&(1<<bits)-1}this.currentOffset+=padding;return val|this.getBits(bits-padding)<<padding}},{key:"eof",value:function eof(){return this.currentOffset>>3>=this.data.length}},{key:"toBase64",value:function toBase64(){var res="";while(!this.eof()){var elem=this.getBits(6);res+=this.base64[elem]}this.reset();return res}},{key:"fromBase64",value:function fromBase64(str){for(var i=0;i<str.length;i++){var char=str[i];var index=this.base64.indexOf(char);this.addBits(6,index)}this.done();var base64=this.toBase64();console.assert(str===base64)}}]);return RawBuffer}();var PlayerStateElem=function PlayerStateElem(frame,value){_classCallCheck(this,PlayerStateElem);this.frame=frame;this.value=value};var PlayerState=function(){function PlayerState(){_classCallCheck(this,PlayerState);this.angles=[];this.moves=[];this.shootes=[];this.anglesIndex=0;this.movesIndex=0;this.shootesIndex=0}_createClass(PlayerState,[{key:"checkPlayer",value:function checkPlayer(player,frame){var angle=this.angles.length===0?0:this.angles[this.angles.length-1].value;var move=this.moves.length===0?false:this.moves[this.moves.length-1].value;if(angle!==player.angle)this.angles.push(new PlayerStateElem(frame,player.angle));if(move!==player.vel>.5)this.moves.push(new PlayerStateElem(frame,player.vel>.5));if(player.shoot)this.shootes.push(new PlayerStateElem(frame,player.shoot))}},{key:"applyPlayer",value:function applyPlayer(player,frame){if(this.anglesIndex<this.angles.length){var angle=this.angles[this.anglesIndex];console.assert(angle.frame>=frame);if(angle.frame===frame){player.pendingAngle=angle.value;this.anglesIndex++}}if(this.movesIndex<this.moves.length){var move=this.moves[this.movesIndex];console.assert(move.frame>=frame);if(move.frame===frame){player.pendingVel=this.movesIndex%2|0?0:player.velocity;this.movesIndex++}}if(this.shootesIndex<this.shootes.length){var shoot=this.shootes[this.shootesIndex];console.assert(shoot.frame>=frame);if(shoot.frame===frame){player.pendingShoot=true;this.shootesIndex++}}}},{key:"toBuffer",value:function toBuffer(buffer){var saveArray=function saveArray(array){buffer.addUint16(array.length);console.log("Array length = "+array.length);if(array.length===0)return;var lastFrame=array[array.length-1].frame;var avgDelta=lastFrame/array.length|0;var log2=0;while(avgDelta){avgDelta>>=1;log2++}var saveToBuffer=function saveToBuffer(buf,log){buf.addBits(4,log);var ffff=(1<<log)-1;var last=0;array.forEach(function(elem){var delta=elem.frame-last;last=elem.frame;if(delta<ffff){buf.addBits(log,delta);return}buf.addBits(log,ffff);if(delta===ffff){buf.addBits(8,255)}else{var count=delta/ffff|0;buf.addBits(8,count);buf.addBits(log,delta%ffff|0)}})};var minSize=buffer.length*2;var minLog=log2;for(var i=Math.min(8,log2-1);i<=log2+2;i++){var testBuf=new RawBuffer;saveToBuffer(testBuf,i);testBuf.done();console.log("For log = "+i+", size = "+testBuf.data.length);if(testBuf.data.length<minSize){minSize=testBuf.data.length;minLog=i}}saveToBuffer(buffer,minLog)};saveArray(this.angles);saveArray(this.moves);saveArray(this.shootes);this.angles.forEach(function(elem){return buffer.addBits(2,elem.value)})}},{key:"fromBuffer",value:function fromBuffer(buffer){var loadArray=function loadArray(array){var length=buffer.getUint16();if(length===0)return;var log=buffer.getBits(4);var ffff=(1<<log)-1;var last=0;for(var i=0;i<length;i++){var elem=new PlayerStateElem(0,0);var delta=buffer.getBits(log);if(delta===ffff){delta=buffer.getBits(8);if(delta===255)delta=ffff;else{var count=delta;delta=count*ffff+buffer.getBits(log)}}elem.frame=last+delta;last=elem.frame;array.push(elem)}};loadArray(this.angles);loadArray(this.moves);loadArray(this.shootes);this.angles.forEach(function(elem){elem.value=buffer.getBits(2)})}}]);return PlayerState}();var Replay=function(){function Replay(level){var _playersState,_items,_this=this;var items=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var tanks=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;_classCallCheck(this,Replay);this.players={};this.leftItems=[];this.frameNumber=0;this.playbackFrame=0;this.playersState=(_playersState={},_defineProperty(_playersState,_global.TANK.TANK1,new PlayerState),_defineProperty(_playersState,_global.TANK.TANK2,new PlayerState),_playersState);if(!tanks)return;this.random_seed=_utils.Random.getSeed();this.level=level;this.difficulty=tanks.difficulty;this.life=tanks.life;this.scores=tanks.scores;this.total_scores=tanks.total_scores;this.items=(_items={},_defineProperty(_items,_global.ITEM.FIREBALL,tanks.items[_global.ITEM.FIREBALL]),_defineProperty(_items,_global.ITEM.SPEED,tanks.items[_global.ITEM.SPEED]),_defineProperty(_items,_global.ITEM.STAR,tanks.items[_global.ITEM.STAR]),_items);tanks.objects.forEach(function(tank){if(tank.type<=_global.TANK.TANK2){_this.players[tank.type]={weaponType:tank.weapon.type,life:tank.life,maxVelocity:tank.velocity>2}}});items.objects.forEach(function(item){_this.leftItems.push({type:item.type,cx:item.cx,cy:item.cy})})}_createClass(Replay,[{key:"processPlayers",value:function processPlayers(players){var _this2=this;players.forEach(function(pl){if(!pl)return;_this2.playersState[pl.type].checkPlayer(pl,_this2.frameNumber)});this.frameNumber++}},{key:"applyPlayers",value:function applyPlayers(players){var _this3=this;players.forEach(function(pl){if(!pl)return;_this3.playersState[pl.type].applyPlayer(pl,_this3.playbackFrame)});this.playbackFrame++;return this.playbackFrame<this.frameNumber}},{key:"save",value:function save(){var buffer=new RawBuffer;buffer.addUint32(this.random_seed);buffer.addBits(3,this.level);buffer.addBits(4,this.difficulty);buffer.addBits(4,this.life);buffer.addBits(9,this.scores);buffer.addUint16(this.total_scores);buffer.addUint16(this.frameNumber);buffer.addBool(this.items[_global.ITEM.FIREBALL]);buffer.addBool(this.items[_global.ITEM.SPEED]);buffer.addBool(this.items[_global.ITEM.STAR]);buffer.addBool(this.players[_global.TANK.TANK1]);buffer.addBool(this.players[_global.TANK.TANK2]);if(this.players[_global.TANK.TANK1]){buffer.addBits(3,this.players[_global.TANK.TANK1].weaponType);buffer.addBits(3,this.players[_global.TANK.TANK1].life);buffer.addBool(this.players[_global.TANK.TANK1].maxVelocity);this.playersState[_global.TANK.TANK1].toBuffer(buffer)}if(this.players[_global.TANK.TANK2]){buffer.addBits(3,this.players[_global.TANK.TANK2].weaponType);buffer.addBits(3,this.players[_global.TANK.TANK2].life);buffer.addBool(this.players[_global.TANK.TANK2].maxVelocity);this.playersState[_global.TANK.TANK2].toBuffer(buffer)}buffer.addBits(5,this.leftItems.length);this.leftItems.forEach(function(item){buffer.addBits(3,item.type);buffer.addBits(6,item.cx);buffer.addBits(5,item.cy)});buffer.done();var base64=buffer.toBase64();var key="replay1";_local_storage2.default.saveReplay(key,base64);var replayRef=""+window.location.origin+window.location.pathname+"?mode=replay&base64="+base64;console.log("Replay = "+replayRef);console.log("Replay size = "+base64.length);var type="text/plain";var blob=new Blob([replayRef],{type:type});var data=[new ClipboardItem(_defineProperty({},type,blob))];navigator.clipboard.write(data);var loadReplay=_local_storage2.default.loadReplay(key);var load=new Replay;load.load(loadReplay);console.assert(load.random_seed===this.random_seed);console.assert(load.level===this.level);console.assert(load.difficulty===this.difficulty);console.assert(load.life===this.life);console.assert(load.scores===this.scores);console.assert(load.total_scores===this.total_scores);console.assert(load.frameNumber===this.frameNumber);console.assert(load.items[_global.ITEM.FIREBALL]===this.items[_global.ITEM.FIREBALL]);console.assert(load.items[_global.ITEM.SPEED]===this.items[_global.ITEM.SPEED]);console.assert(load.items[_global.ITEM.STAR]===this.items[_global.ITEM.STAR]);console.assert(!!load.players[_global.TANK.TANK1]===!!this.players[_global.TANK.TANK1]);console.assert(!!load.players[_global.TANK.TANK2]===!!this.players[_global.TANK.TANK2]);if(load.players[_global.TANK.TANK1]){console.assert(load.players[_global.TANK.TANK1].weaponType===this.players[_global.TANK.TANK1].weaponType);console.assert(load.players[_global.TANK.TANK1].life===this.players[_global.TANK.TANK1].life);console.assert(load.players[_global.TANK.TANK1].maxVelocity===this.players[_global.TANK.TANK1].maxVelocity);console.assert(load.playersState[_global.TANK.TANK1].angles.length===this.playersState[_global.TANK.TANK1].angles.length);console.assert(load.playersState[_global.TANK.TANK1].moves.length===this.playersState[_global.TANK.TANK1].moves.length);console.assert(load.playersState[_global.TANK.TANK1].shootes.length===this.playersState[_global.TANK.TANK1].shootes.length)}if(load.players[_global.TANK.TANK2]){console.assert(load.players[_global.TANK.TANK2].weaponType===this.players[_global.TANK.TANK2].weaponType);console.assert(load.players[_global.TANK.TANK2].life===this.players[_global.TANK.TANK2].life);console.assert(load.players[_global.TANK.TANK2].maxVelocity===this.players[_global.TANK.TANK2].maxVelocity)}console.assert(load.leftItems.length===this.leftItems.length);for(var i=0;i<load.leftItems.length;i++){console.assert(load.leftItems[i].type===this.leftItems[i].type);console.assert(load.leftItems[i].cx===this.leftItems[i].cx);console.assert(load.leftItems[i].cy===this.leftItems[i].cy)}}},{key:"load",value:function load(base64){var _items2;var load=new RawBuffer;load.fromBase64(base64);this.random_seed=load.getUint32();this.level=load.getBits(3);this.difficulty=load.getBits(4);this.life=load.getBits(4);this.scores=load.getBits(9);this.total_scores=load.getUint16();this.frameNumber=load.getUint16();this.items=(_items2={},_defineProperty(_items2,_global.ITEM.FIREBALL,load.getBool()),_defineProperty(_items2,_global.ITEM.SPEED,load.getBool()),_defineProperty(_items2,_global.ITEM.STAR,load.getBool()),_items2);var pl1=load.getBool();var pl2=load.getBool();if(pl1){this.players[_global.TANK.TANK1]={weaponType:load.getBits(3),life:load.getBits(3),maxVelocity:load.getBool()};this.playersState[_global.TANK.TANK1].fromBuffer(load)}if(pl2){this.players[_global.TANK.TANK2]={weaponType:load.getBits(3),life:load.getBits(3),maxVelocity:load.getBool()};this.playersState[_global.TANK.TANK2].fromBuffer(load)}var leftItems=load.getBits(5);for(var i=0;i<leftItems;i++){this.leftItems.push({type:load.getBits(3),cx:load.getBits(6),cy:load.getBits(5)})}}}]);return Replay}();exports.default=Replay},{"./global":7,"./local_storage":10,"./utils":15}],14:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _entity=require("./entity");var _weapon=require("./weapon");var _weapon2=_interopRequireDefault(_weapon);var _global=require("./global");var _utils=require("./utils");var _local_storage=require("./local_storage");var _local_storage2=_interopRequireDefault(_local_storage);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Tank=function(_Entity){_inherits(Tank,_Entity);function Tank(type,time,difficulty,event){var level=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;_classCallCheck(this,Tank);var _this=_possibleConstructorReturn(this,(Tank.__proto__||Object.getPrototypeOf(Tank)).call(this,0,0));_this.type=type;_this.weapon=new _weapon2.default(_this,(0,_global.tankWeaponType)(type));_this.life=(0,_global.tankLife)(type);_this.velocity=(0,_global.tankVelocity)(type);_this.difficulty=difficulty;_this.event=event;_this.smokeTime=0;_this.respawn(time,level);return _this}_createClass(Tank,[{key:"respawn",value:function respawn(time){var level=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;this.animTrack=0;this.animTurret=0;this.shoot=false;this.zombie=false;this.turret=new _entity.Entity(0,0);this.shield=new _entity.Entity(0,0,3);this.text={obj:new _entity.Entity(0,0,3),tex:0,time:0};this.weapon.reset();this.state=_global.STATE.RESPAWN;this.stateTime=time+2e3;var _getMapSize=(0,_utils.getMapSize)(),mapWidth=_getMapSize.mapWidth,mapHeight=_getMapSize.mapHeight;if(this.type<=_global.TANK.TANK2){this.angle=0;this.cx=mapWidth/2-5;this.cy=mapHeight-3;if(this.type===_global.TANK.TANK2)this.cx+=8;this.pendingShoot=false;this.pendingAngle=0;this.pendingVel=0}else if(this.type===_global.TANK.EAGLE){this.cx=mapWidth/2-1;this.cy=mapHeight-3;this.state=_global.STATE.NORMAL}else{console.assert(this.type===_global.TANK.RANDOM,"Should be unknown type of bot");console.assert(level,"Need level object for generate position of bot");this.type=(0,_global.botTypeProbability)(this.difficulty);this.angle=2;this.cy=1;do{this.cx=_utils.Random.next(mapWidth-4)+1|0}while(level.collideTankEx(this));this.weapon.setType((0,_global.tankWeaponType)(this.type));this.life=(0,_global.tankLife)(this.type);this.velocity=(0,_global.tankVelocity)(this.type);this.vel=this.velocity}this.dirTime=0;this.shootTime=0;this.changedDir=false;this.maxlife=this.life}},{key:"clear",value:function clear(level){level.clearEntity(this.state===_global.STATE.GOD?this.shield:this);if(this.text.time)level.clearEntity(this.text.obj)}},{key:"draw",value:function draw(level){if(this.state===_global.STATE.RESPAWN){var ind=Date.now()%800/50%level.textures.respawn.length|0;level.drawEntity(this,level.textures.respawn[ind])}else{if(this.type===_global.TANK.EAGLE){level.drawEntityBegin(this,level.textures.eagle)}else{var trackIndex=(this.animTrack/16|0)%level.textures.tankTrack[this.angle][_global.TANK.BMP].length|0;if(this.type<=_global.TANK.TANK2&&this.velocity>2){level.drawEntityBegin(this,level.textures.tankTrack[this.angle][_global.TANK.BMP][trackIndex])}else{level.drawEntityBegin(this,level.textures.tankTrack[this.angle][this.type][trackIndex])}level.drawEntityBegin(this,level.textures.tankBodies[this.angle][this.type]);if(this.zombie){level.drawEntityBegin(this.turret,level.textures.tankTurretFF[this.angle])}else if(this.type<=_global.TANK.TANK2&&this.weapon.type&_global.BULLET.POWER){level.drawEntityBegin(this.turret,level.textures.tankTurretEx[this.angle][this.type])}else{level.drawEntityBegin(this.turret,level.textures.tankTurret[this.angle][this.type])}}if(this.state===_global.STATE.GOD){var _ind=(0,_utils.floatToIndex)(Math.random(),level.textures.shield.length);level.drawEntity(this.shield,level.textures.shield[_ind])}if(this.text.time){level.drawEntityBegin(this.text.obj,level.textures.itemText[this.text.tex])}if(this.state!==_global.STATE.GOD){level.drawEntityEnd(this)}}}},{key:"update",value:function update(level,tanks,time){if(this.type===_global.TANK.EAGLE)return;if(this.state===_global.STATE.RESPAWN){if(time>this.stateTime){this.state=_global.STATE.GOD;this.stateTime=time+3e3;this.shootTime=time+(0,_global.shootTime)(this.difficulty);for(var tank=this.collideTanks(tanks);tank;tank=this.collideTanks(tanks)){tank.damage(-1)}}this.shoot=false}else{if(this.state===_global.STATE.GOD){if(time>this.stateTime)this.state=_global.STATE.NORMAL}if(this.type>_global.TANK.TANK2){if(time>this.dirTime){this.dirTime=time+(0,_global.directionTime)(false);this.angle=(0,_global.angleProbability)();this.changedDir=true}if(time>this.shootTime){this.shootTime=time+(0,_global.shootTime)(this.difficulty);this.shoot=_utils.Random.next(2)===1}}if(this.angle===0||this.angle===2)this.cx=Math.round(this.cx);if(this.angle===1||this.angle===3)this.cy=Math.round(this.cy);var delta=this.getDelta(time);this.move(delta);if(level.collideTank(this)||this.collideTanks(tanks)){this.move(-delta);if(this.changedDir){this.dirTime=time+(0,_global.directionTime)(true);this.changedDir=false}}else if(this.vel>.01){this.animTrack+=delta}this.animTurret*=.99}this.turret.cx=this.cx+(0,_utils.cos)(this.angle)*this.animTurret;this.turret.cy=this.cy+(0,_utils.sin)(this.angle)*this.animTurret;this.shield.cx=this.cx;this.shield.cy=this.cy;this.text.obj.cx=this.cx;this.text.obj.cy=this.cy-1.5;if(Date.now()>this.text.time)this.text.time=0}},{key:"applyPendings",value:function applyPendings(){console.assert(this.type<=_global.TANK.TANK2);this.shoot=this.pendingShoot;this.angle=this.pendingAngle;this.vel=this.pendingVel;this.pendingShoot=false}},{key:"setText",value:function setText(itemType){this.text.time=Date.now()+3e3;if(itemType>_global.ITEM.FIREBALL)this.text.time+=3e3;this.text.tex=itemType}},{key:"setZombie",value:function setZombie(){this.zombie=true}},{key:"damage",value:function damage(value,notify){if(value<0)this.state=_global.STATE.DEAD;else if(this.state!==_global.STATE.GOD){this.life-=value;for(var i=0;i<value;i++){this.weapon.dec()}if(this.life<=0){this.state=_global.STATE.DEAD;if(notify)this.event.emit("botDead",this.type)}}else if(value>1){this.state=_global.STATE.NORMAL}}},{key:"upgrade",value:function upgrade(type){switch(type){case _global.ITEM.STAR:{var old=this.weapon.type;this.weapon.inc();this.life=Math.min(this.life+1,6);this.maxlife=this.life;return old!==this.weapon.type}case _global.ITEM.SPEED:{var _old=this.velocity;this.velocity=(0,_global.tankVelocity)(_global.TANK.BMP);if(this.type>_global.TANK.TANK2)this.vel=this.velocity;return _old<2}case _global.ITEM.FIREBALL:{var _old2=this.weapon.type;this.weapon.setFire();return _old2!==this.weapon.type}default:return false}}},{key:"updateWeapon",value:function updateWeapon(){var bullet=this.shoot?this.weapon.shoot():null;this.shoot=false;if(bullet){this.animTurret=-.5}return bullet}},{key:"collideTanks",value:function collideTanks(tanks){var cx=Math.round(this.cx);var cy=Math.round(this.cy);for(var i=0;i<tanks.length;i++){var tank=tanks[i];if(tank!==this&&tank.state>_global.STATE.RESPAWN){var tx=Math.round(tank.cx);var ty=Math.round(tank.cy);if(Math.abs(cx-tx)<2&&Math.abs(cy-ty)<2)return tank}}return null}}]);return Tank}(_entity.Entity);var TankManager=function(_EntityManager){_inherits(TankManager,_EntityManager);function TankManager(difficulty,event,mode){var _this2$items;_classCallCheck(this,TankManager);var _this2=_possibleConstructorReturn(this,(TankManager.__proto__||Object.getPrototypeOf(TankManager)).call(this));_this2.difficulty=(0,_utils.clamp)(difficulty,0,15);_this2.start_difficulty=_this2.difficulty;_this2.event=event;_this2.mode=mode;_this2.life=2;_this2.scores=0;_this2.total_scores=0;if(_this2.mode==="level"){_this2.best_scores=_local_storage2.default.getBestScore(_this2.start_difficulty)}_this2.end_of_time=false;_this2.items=(_this2$items={},_defineProperty(_this2$items,_global.ITEM.FIREBALL,false),_defineProperty(_this2$items,_global.ITEM.SPEED,false),_defineProperty(_this2$items,_global.ITEM.STAR,false),_this2$items);event.on("item",function(type,tank){tank.setText(type);switch(type){case _global.ITEM.LIFE:if(tank.type<=_global.TANK.TANK2)_this2.life++;else _this2.life=Math.max(_this2.life-1,0);break;case _global.ITEM.KNUKLE:case _global.ITEM.ZOMBIE:{var isEnemy=function isEnemy(t){return t<=_global.TANK.TANK2!==tank.type<=_global.TANK.TANK2||_this2.mode==="bench"};var damageVal=tank.type<=_global.TANK.TANK2||_this2.mode==="bench"?-1:1;_this2.objects.forEach(function(bot){if(bot.state>_global.STATE.RESPAWN&&isEnemy(bot.type)&&bot.type!==_global.TANK.EAGLE){if(type===_global.ITEM.KNUKLE)bot.damage(damageVal);else bot.setZombie()}});break}case _global.ITEM.STAR:case _global.ITEM.SPEED:case _global.ITEM.FIREBALL:{var upgraded=tank.upgrade(type);if(!upgraded&&tank.type<=_global.TANK.TANK2)_this2.items[type]=true;break}default:break}});event.on("botDead",function(type){_this2.scores+=(0,_global.getScores)(type);_this2.total_scores+=(0,_global.getScores)(type);if(_this2.mode==="level"){_this2.best_scores=_local_storage2.default.setBestScore(_this2.start_difficulty,_this2.total_scores)}if(_this2.scores>(0,_global.scoreToLevelup)(_this2.difficulty)){_this2.difficulty=Math.min(_this2.difficulty+1,15);_this2.scores=0;_this2.objects.forEach(function(tank){if(tank.type<=_global.TANK.TANK2)tank.setText(_global.ITEM.FIREBALL+_this2.difficulty+1)});event.emit("levelup",_this2.difficulty)}});event.on("endOfTime",function(){_this2.end_of_time=_this2.mode!=="bench"});return _this2}_createClass(TankManager,[{key:"create",value:function create(type){var time=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var level=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var tank=new Tank(type,time,this.difficulty,this.event,level);this.objects.push(tank);return tank}},{key:"reset",value:function reset(){this.objects=this.objects.filter(function(tank){return tank.type<=_global.TANK.TANK2});this.objects.forEach(function(tank){return tank.respawn(0)});this.create(_global.TANK.EAGLE);this.timeRespawn=0;this.end_of_time=false;this.end=false}},{key:"draw",value:function draw(level,progress){_get(TankManager.prototype.__proto__||Object.getPrototypeOf(TankManager.prototype),"draw",this).call(this,level);level.drawInterface(this.life,this.items[_global.ITEM.FIREBALL],this.items[_global.ITEM.SPEED],this.items[_global.ITEM.STAR],this.mode==="bench"?1:progress,_global.ITEM.FIREBALL+this.difficulty+1,this.total_scores,this.best_scores)}},{key:"update",value:function update(level,bullets,time){if(this.end)return;if(time>this.timeRespawn&&!this.end_of_time){this.timeRespawn=time+(0,_global.timeToRespawn)(this.difficulty);this.create(_global.TANK.RANDOM,time,level)}if(this.end_of_time){var countBots=0;this.objects.forEach(function(tank){if(tank.type>_global.TANK.TANK2&&tank.type<_global.TANK.RANDOM)countBots++});if(countBots===0){this.end=true;this.event.emit("levelComplete")}}for(var i=0;i<this.objects.length;i++){var tank=this.objects[i];if(tank.state===_global.STATE.DEAD){this.event.emit("tankDead",tank);if(tank.type<=_global.TANK.TANK2){if(this.life>0){this.life--;var player=this.create(tank.type,time);this.event.emit("playerCreated",player);for(var type=_global.ITEM.LIFE;type<=_global.ITEM.FIREBALL;type++){if(type in this.items){if(this.items[type]){player.upgrade(type);this.items[type]=false}}}}else if(this.mode!=="bench"){this.event.emit("gameOver")}}else if(tank.type===_global.TANK.EAGLE){this.event.emit("gameOver")}tank.alive=false}tank.update(level,this.objects,time);var bullet=tank.updateWeapon();if(bullet){bullets.add(bullet)}bullets.collideTank(tank);if(tank.state!==_global.STATE.DEAD&&tank.life<tank.maxlife&&Date.now()>tank.smokeTime){tank.smokeTime=Date.now()+16;var smoke=_global.PART.SMOKE0;if(tank.life===1)smoke=_global.PART.SMOKE3;else if(tank.maxlife-tank.life===1)smoke=_global.PART.SMOKE0;else if(tank.life/tank.maxlife>.5)smoke=_global.PART.SMOKE1;else smoke=_global.PART.SMOKE2;this.event.emit("particle",tank.cx,tank.cy,smoke)}}this.splice()}}]);return TankManager}(_entity.EntityManager);exports.default=TankManager},{"./entity":2,"./global":7,"./local_storage":10,"./utils":15,"./weapon":16}],15:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();exports.rand=rand;exports.mathRand=mathRand;exports.clamp=clamp;exports.randColor=randColor;exports.getMapSize=getMapSize;exports.getTileSize=getTileSize;exports.cos=cos;exports.sin=sin;exports.getProbability=getProbability;exports.floatToIndex=floatToIndex;function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var randomSeed=42;var Random=exports.Random=function(){function Random(){_classCallCheck(this,Random)}_createClass(Random,null,[{key:"setSeed",value:function setSeed(seed){randomSeed=seed}},{key:"getSeed",value:function getSeed(){return randomSeed}},{key:"next",value:function next(m){randomSeed=randomSeed*214013+2531011&4294967295;var ret=randomSeed>>16&32767;return ret%m}}]);return Random}();function rand(m,radius){return Random.next(2*radius)-radius+m}function mathRand(m,radius){return Math.random()*(2*radius)-radius+m}function clamp(a,min,max){return Math.max(min,Math.min(max,a))}function randColor(color){var radius=arguments.length>1&&arguments[1]!==undefined?arguments[1]:10;var ret=new Array(3);for(var i=0;i<3;i++){ret[i]=clamp(mathRand(color[i],radius),0,255)}return ret}function getMapSize(){var mapWidth=36;var mapHeight=20;mapWidth+=1+1;mapHeight+=1+1;return{mapWidth:mapWidth,mapHeight:mapHeight}}function getTileSize(width,height){var _getMapSize=getMapSize(),mapWidth=_getMapSize.mapWidth,mapHeight=_getMapSize.mapHeight;var tileWidth=width/mapWidth|0;var tileHeight=height/mapHeight|0;return Math.min(tileWidth,tileHeight)}function cos(angle){return[0,1,0,-1][angle]}function sin(angle){return[-1,0,1,0][angle]}function getProbability(probabilities){var sum=probabilities.reduce(function(acc,val){return acc+val});var current=Random.next(sum);for(var i=0;i<probabilities.length;i++){current-=probabilities[i];if(current<0)return i}return 0}function floatToIndex(float,maxIndex){var ret=(float*maxIndex|0)%maxIndex|0;return ret<0?ret+maxIndex:ret}},{}],16:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _bullet=require("./bullet");var _global=require("./global");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Weapon=function(){function Weapon(owner,type){_classCallCheck(this,Weapon);this.owner=owner;this.setType(type)}_createClass(Weapon,[{key:"reset",value:function reset(){this.count=(0,_global.bulletsCount)(this.type)}},{key:"setType",value:function setType(type){this.type=type;this.count=(0,_global.bulletsCount)(type)}},{key:"setFire",value:function setFire(){this.type|=_global.BULLET.FIRE}},{key:"changeType",value:function changeType(type){var old=(0,_global.bulletsCount)(this.type);this.type&=~_global.BULLET.POWER;this.type|=type;var current=(0,_global.bulletsCount)(this.type);this.count+=current-old}},{key:"inc",value:function inc(){var next=Math.min((this.type&_global.BULLET.POWER)+1,_global.BULLET.POWER);this.changeType(next)}},{key:"dec",value:function dec(){var prev=Math.max((this.type&_global.BULLET.POWER)-1,_global.BULLET.SIMPLE);this.changeType(prev)}},{key:"shoot",value:function shoot(){var _this=this;if(this.count){this.count--;return new _bullet.Bullet(this.owner,this.type,function(){return _this.count++})}return null}}]);return Weapon}();exports.default=Weapon},{"./bullet":1,"./global":7}]},{},[11]);